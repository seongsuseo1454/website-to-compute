<!-- index.html — FINAL (수정/보강용) -->
<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>시장님 집무실 · 스마트 미러 PRO</title>

  <!-- PWA -->
  <link rel="manifest" href="/manifest.webmanifest" />
  <link rel="icon" sizes="192x192" href="/icon-192.png" />
  <link rel="icon" sizes="512x512" href="/icon-512.png" />
  <meta name="theme-color" content="#0b0f19" />

  <link rel="stylesheet" href="/style.css" />
</head>
<body>
<main class="container">
  <!-- 상단 인사/시계 (기존 유지) -->
  <section class="hero">
    <div>
      <h1 id="greet">활기찬 하루입니다, 시장님</h1>
      <p class="sub" id="today"></p>
    </div>
    <div class="clock" id="clock">--:--</div>
  </section>

  <!-- 빠른 업무 트리거 (기존 유지: id=trstart 반드시 유지) -->
  <section id="trstart" class="card">
    <div class="title">업무 트리거 & 빠른 전환</div>
    <div class="desc">자주 쓰는 명령을 터치로 실행하세요.</div>
    <div class="row">
      <button class="btn" onclick="
        document.getElementById('msgInput').value='내일 10시 복지과 회의 추가';
        document.getElementById('chatForm').dispatchEvent(new Event('submit',{cancelable:true}))">
        내일 10시 회의 추가
      </button>
      <button class="btn" onclick="location.href='/admin.html'">관리자 입력창</button>
    </div>
  </section>

  <!-- 오늘의 날씨 (기존 유지) -->
  <section class="card">
    <header class="card-title">오늘의 날씨</header>
    <div id="weatherBox" class="weather">불러오는 중...</div>
  </section>

  <!-- AI 비서 (채팅 + 음성) (기존 유지) -->
  <section class="card">
    <header class="card-title">AI 비서 (채팅 + 음성)</header>
    <div id="chat" class="chat">
      <div class="bot">안녕하세요, 시장님. 무엇을 도와드릴까요?</div>
    </div>

    <form id="chatForm" class="chat-form">
      <button type="button" id="micBtn" title="음성으로 말하기" class="ghost big-mic">🎤</button>
      <input id="msgInput" type="text" placeholder="메시지를 입력하세요. (예: 오늘 일정 요약)" autocomplete="off" />
      <button type="submit" class="primary">보내기</button>
    </form>

    <div class="tts-row">
      <label><input type="checkbox" id="ttsToggle" checked /> 응답을 음성으로 읽기</label>
      <div class="spacer"></div>
      <button id="ttsPause" class="ghost">⏸︎ 일시정지</button>
      <button id="ttsResume" class="ghost">▶︎ 재개</button>
      <button id="ttsStop" class="danger ghost">■ 정지</button>
    </div>
    <p class="hint">※ 특수문자/이모지/마크다운 등은 읽기 전에 자동 정리됩니다.</p>
  </section>

  <!-- (추가) 음성 설정: 성별/언어/속도 -->
<section class="card">
  <header class="card-title">음성 설정</header>
  <div class="row" style="gap:12px;flex-wrap:wrap;align-items:center">
    <label>출력 언어
      <select id="ttsLang">
        <option value="ko-KR">한국어</option>
        <option value="en-US">English (US)</option>
        <option value="ja-JP">日本語</option>
        <option value="zh-CN">中文(简体)</option>
        <option value="fr-FR">Français</option>
        <option value="de-DE">Deutsch</option>
        <option value="es-ES">Español</option>
        <option value="pt-BR">Português</option>
        <option value="ru-RU">Русский</option>
        <option value="vi-VN">Tiếng Việt</option>
        <option value="th-TH">ไทย</option>
        <option value="id-ID">Bahasa Indonesia</option>
        <option value="ar-SA">العربية</option>
        <option value="hi-IN">हिन्दी</option>
      </select>
    </label>

    <label>목소리 성별
      <select id="ttsGender">
        <option value="auto">자동</option>
        <option value="female">여성</option>
        <option value="male">남성</option>
      </select>
    </label>

    <label>속도
      <input id="ttsRate" type="range" min="0.7" max="1.3" step="0.05" value="1.0" />
    </label>
  </div>
  <p class="hint">※ 브라우저가 제공하는 TTS 음성 중에서 언어/성별에 가장 가까운 음성을 자동 선택합니다.</p>
</section>

  <!-- 오늘 일정 (기존 유지) -->
  <section class="card">
    <header class="card-title">오늘 일정</header>
    <ul id="schedList" class="sched"></ul>
  </section>

  <!-- 시정 뉴스 / 부서별 보고 (기존 유지) -->
  <section class="grid">
    <div class="card">
      <header class="card-title">시정 뉴스</header>
      <ul id="newsList" class="feed"></ul>
    </div>
    <div class="card">
      <header class="card-title">부서별 업무보고</header>
      <ul id="deptList" class="feed"></ul>
    </div>
  </section>

  <!-- 실시간 통역 (신규 보강: 14개 언어) -->
  <section class="card">
    <header class="card-title">실시간 통역 (14개 언어)</header>

    <div class="row" style="gap:12px; align-items:center; flex-wrap:wrap">
      <label>입력(말하기)
        <select id="trSrc">
          <option value="ko">한국어</option><option value="en">English</option>
          <option value="ja">日本語</option><option value="zh">中文</option>
          <option value="fr">Français</option><option value="de">Deutsch</option>
          <option value="es">Español</option><option value="pt">Português</option>
          <option value="ru">Русский</option><option value="vi">Tiếng Việt</option>
          <option value="th">ไทย</option><option value="id">Bahasa Indonesia</option>
          <option value="ar">العربية</option><option value="hi">हिन्दी</option>
        </select>
      </label>

      <label>출력(읽어주기)
        <select id="trDst">
          <option value="en">English</option><option value="ko">한국어</option>
          <option value="ja">日本語</option><option value="zh">中文</option>
          <option value="fr">Français</option><option value="de">Deutsch</option>
          <option value="es">Español</option><option value="pt">Português</option>
          <option value="ru">Русский</option><option value="vi">Tiếng Việt</option>
          <option value="th">ไทย</option><option value="id">Bahasa Indonesia</option>
          <option value="ar">العربية</option><option value="hi">हिन्दी</option>
        </select>
      </label>

      <button id="trStart" class="btn-xl primary" title="말하기 시작">🎤 크게 말하기</button>
      <button id="trStop"  class="ghost danger" disabled>■ 통역 정지</button>
    </div>

    <div class="row" style="gap:12px; margin-top:12px">
      <textarea id="trIn"  class="mono" placeholder="입력 인식 텍스트…" rows="2" style="flex:1"></textarea>
      <textarea id="trOut" class="mono" placeholder="번역 결과…" rows="2" style="flex:1"></textarea>
    </div>

    <div class="row" style="gap:8px; margin-top:8px">
      <button id="trTranslate" class="ghost">텍스트 번역</button>
      <button id="trSpeak" class="ghost">▶︎ 번역 읽어주기</button>
    </div>
  </section>

  <!-- 바닥 표시 (기존 유지) -->
  <footer class="footer">© 논산시 스마트미러 · 루미나 PRO</footer>
</main>

<!-- 에러 배지 -->
<style>
  .error-badge{position:fixed;right:12px;bottom:12px;background:#ff4d4f;color:#fff;padding:8px 10px;border-radius:8px;font-size:12px;display:none;z-index:9999}
</style>
<div id="errorBadge" class="error-badge">문제 감지 · 팀에 보고됨</div>

<!-- 비서/유틸 스크립트 -->
<script src="/ai.js"></script>
<script>
/* ===== 공통 ===== */
const $ = (s)=>document.querySelector(s);
const chat = $('#chat'), input=$('#msgInput'), form=$('#chatForm');
const micBtn=$('#micBtn'), ttsToggle=$('#ttsToggle');
const ttsPause=$('#ttsPause'), ttsResume=$('#ttsResume'), ttsStop=$('#ttsStop');

// 시계/날짜/인사
function tick(){
  const now=new Date();
  $('#clock').textContent = now.toLocaleTimeString('ko-KR',{hour:'2-digit',minute:'2-digit'});
  $('#today').textContent = now.toLocaleDateString('ko-KR',{year:'numeric',month:'2-digit',day:'2-digit',weekday:'long'});
  const h=now.getHours();
  $('#greet').textContent = (h<12?'좋은 아침입니다':'활기찬 하루입니다') + ', 시장님';
}
setInterval(tick,1000); tick();

// 채팅 출력
function pushMsg(role, text){
  const div=document.createElement('div');
  div.className = role==='user'?'user':'bot';
  div.textContent = text;
  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;
}

/* ===== TTS ===== */
function speak(text){
  if(!ttsToggle.checked) return;
  const line = window.sanitizeForTTS ? window.sanitizeForTTS(text): text;
  if(!line) return;
  window.speechSynthesis.cancel();
  const u=new SpeechSynthesisUtterance(line);
  u.lang='ko-KR'; u.rate=1.0; u.pitch=1.0;
  window.speechSynthesis.speak(u);
}
ttsPause.onclick=()=>window.speechSynthesis.pause();
ttsResume.onclick=()=>window.speechSynthesis.resume();
ttsStop.onclick=()=>window.speechSynthesis.cancel();

/* ===== STT (채팅용) ===== */
let rec;
if('webkitSpeechRecognition' in window){
  const R=window.webkitSpeechRecognition; rec=new R();
  rec.lang='ko-KR'; rec.continuous=false; rec.interimResults=false;
  rec.onresult=(e)=>{ const txt=e.results[0][0].transcript; input.value=txt;
    form.dispatchEvent(new Event('submit',{cancelable:true})); };
  rec.onerror=()=>alert('음성 인식 오류. 다시 시도해 주세요.');
}else{
  micBtn.disabled=true; micBtn.title='이 브라우저는 음성 인식을 지원하지 않습니다.';
}
micBtn.onclick=()=>{ try{ rec && rec.start(); }catch(_){} };

/* ===== AI 호출 ===== */
async function callAI(prompt){
  if(typeof window.askAI==='function') return await window.askAI(prompt);
  const res = await fetch('/api/ai',{ method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({prompt})});
  if(!res.ok) throw new Error('AI 응답 실패');
  const data=await res.json();
  return data.text || data.reply || JSON.stringify(data);
}

/* ===== 전송 처리 ===== */
form.addEventListener('submit', async (e)=>{
  e.preventDefault();
  const q=input.value.trim(); if(!q) return;
  input.value=''; pushMsg('user',q);
  try{
    const a = await callAI(q);
    pushMsg('bot', a); speak(a);
  }catch(err){
    const msg='에러가 발생했습니다. 곧 조치하겠습니다.'; pushMsg('bot', msg); speak(msg);
    fetch('/api/report',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({type:'AI_FAIL',detail:String(err)})}).catch(()=>{});
  }
});

/* ===== 날씨 (기존 API에 맞춘 폴백) ===== */
async function loadWeather(){
  try{
    const nx=60, ny=127; // 권한 거부 시 기본 좌표
    const res = await fetch(`/api/weather?nx=${nx}&ny=${ny}`);
    const data = await res.json();
    const txt = data?.summary || '날씨 정보를 불러올 수 없습니다.';
    $('#weatherBox').textContent = txt;
  }catch{ $('#weatherBox').textContent='날씨 정보를 불러올 수 없습니다.'; }
}
loadWeather();

/* ===== 일정/뉴스/보고 (기존 저장 데이터 로드) ===== */
async function loadKV(listId, key){
  try{
    const res = await fetch(`/api/admin?list=${encodeURIComponent(key)}`);
    if(!res.ok) throw 0;
    const items = await res.json(); renderList(listId, items);
  }catch{ renderList(listId, []); }
}
function renderList(id, items){
  const el=$(id); el.innerHTML='';
  if(!items || !items.length){
    const li=document.createElement('li'); li.className='empty';
    li.textContent='등록된 항목이 없습니다.'; el.appendChild(li); return;
  }
  for(const it of items){
    const li=document.createElement('li');
    li.innerHTML=`<div class="feed-title">${it.title||it.text}</div>
                  <div class="feed-sub">${it.time||it.source||''} ${it.location||''}</div>`;
    el.appendChild(li);
  }
}
loadKV('#schedList','SCHEDULE:TODAY');
loadKV('#newsList','NEWS');
loadKV('#deptList','DEPT');

/* ===== 에러배지 ===== */
window.addEventListener('error',()=>{$('#errorBadge').style.display='block';});
window.addEventListener('unhandledrejection',()=>{$('#errorBadge').style.display='block';});
</script>

<!-- ===== 실시간 통역 바인딩 (14개 언어) ===== -->
<script>
(function(){
  const trSrc = document.getElementById('trSrc');
  const trDst = document.getElementById('trDst');
  const trStart = document.getElementById('trStart');
  const trStop = document.getElementById('trStop');
  const trIn = document.getElementById('trIn');
  const trOut = document.getElementById('trOut');

  let trRec;

  async function translateText(text, source, target){
    const r = await fetch('/api/translate',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({ q:text, source, target })
    });
    if(!r.ok) throw new Error('번역 실패');
    const data = await r.json();
    return data.text;
  }

  function speakLang(text, lang){
    const clean = (window.sanitizeForTTS ? window.sanitizeForTTS(text) : text) || '';
    if(!clean) return;
    window.speechSynthesis.cancel();
    const u = new SpeechSynthesisUtterance(clean);
    // 브라우저가 지원하는 언어코드로 매핑(간단 매핑)
    const map = { zh:'zh-CN', ja:'ja-JP', ko:'ko-KR', en:'en-US', fr:'fr-FR', de:'de-DE', es:'es-ES',
                  pt:'pt-PT', ru:'ru-RU', vi:'vi-VN', th:'th-TH', id:'id-ID', ar:'ar-SA', hi:'hi-IN' };
    u.lang = map[lang] || lang;
    window.speechSynthesis.speak(u);
  }

  function startSTT(lang){
    if(!('webkitSpeechRecognition' in window)){
      alert('이 브라우저는 음성 인식을 지원하지 않습니다.'); return;
    }
    const R = window.webkitSpeechRecognition;
    trRec = new R();
    const map = { zh:'zh-CN', ja:'ja-JP', ko:'ko-KR', en:'en-US', fr:'fr-FR', de:'de-DE', es:'es-ES',
                  pt:'pt-PT', ru:'ru-RU', vi:'vi-VN', th:'th-TH', id:'id-ID', ar:'ar-SA', hi:'hi-IN' };
    trRec.lang = map[lang] || 'ko-KR';
    trRec.continuous = false;
    trRec.interimResults = false;
    trRec.onresult = async (e)=>{
      const heard = e.results[0][0].transcript || '';
      trIn.value = heard;
      try{
        const out = await translateText(heard, trSrc.value, trDst.value);
        trOut.value = out;
        speakLang(out, trDst.value);
      }catch(err){
        trOut.value = '번역 중 오류가 발생했습니다.';
      }
      trStop.disabled = true;
      trStart.disabled = false;
    };
    trRec.onerror = ()=>{ trStop.disabled = true; trStart.disabled = false; };
    trRec.onend = ()=>{ trStop.disabled = true; trStart.disabled = false; };
    trRec.start();
    trStart.disabled = true;
    trStop.disabled = false;
  }

  trStart.addEventListener('click', ()=> startSTT(trSrc.value));
  trStop.addEventListener('click', ()=> { try{ trRec && trRec.stop(); }catch(_){}
    trStop.disabled = true; trStart.disabled = false; });

  document.getElementById('trTranslate').addEventListener('click', async ()=>{
    const text = trIn.value.trim(); if(!text) return;
    try{
      const out = await translateText(text, trSrc.value, trDst.value);
      trOut.value = out;
    }catch{ trOut.value = '번역 중 오류가 발생했습니다.'; }
  });

  document.getElementById('trSpeak').addEventListener('click', ()=>{
    const text = trOut.value.trim(); if(!text) return;
    speakLang(text, trDst.value);
  });
})();
</script>
</body>
</html>
