<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ì‹œì¥ë‹˜ ì§‘ë¬´ì‹¤ Â· ìŠ¤ë§ˆíŠ¸ ë¯¸ëŸ¬ PRO</title>

  <!-- PWA -->
  <link rel="manifest" href="/manifest.webmanifest" />
  <link rel="icon" sizes="192x192" href="/icon-192.png" />
  <link rel="icon" sizes="512x512" href="/icon-512.png" />
  <meta name="theme-color" content="#0b0f19" />

  <link rel="stylesheet" href="/style.css" />
  <style>
    /* ìµœì†Œ ë³´ì™„ (ê¸°ì¡´ style.css ìœ ì§€ ê°€ì •) */
    .container { max-width: 980px; margin: 24px auto; padding: 16px; }
    .hero { display:flex; justify-content:space-between; align-items:flex-end; margin-bottom: 16px; }
    .hero .sub { opacity:.8 }
    .clock { font-size: 40px; font-weight: 800; opacity:.8 }
    .card { background: rgba(255,255,255,.03); border:1px solid rgba(255,255,255,.08); border-radius:14px; padding:16px; margin-bottom:16px }
    .card-title { font-weight: 800; margin-bottom: 10px; opacity:.9 }
    .row { display:flex; gap:12px; align-items:center; flex-wrap:wrap }
    .grid2 { display:grid; grid-template-columns: 1fr 1fr; gap:16px }
    @media (max-width: 820px){ .grid2 { grid-template-columns: 1fr } }
    .chat{display:flex;flex-direction:column;gap:8px;height:260px;overflow:auto;padding:8px;background:rgba(0,0,0,.15);border-radius:12px}
    .chat .user{align-self:flex-end;background:#3451ff1a;border:1px solid #3451ff44;padding:10px 12px;border-radius:12px 12px 2px 12px;max-width:85%}
    .chat .bot{align-self:flex-start;background:#ffffff0f;border:1px solid #ffffff22;padding:10px 12px;border-radius:12px 12px 12px 2px;max-width:85%}
    .chat-form{display:flex;gap:8px;margin-top:10px}
    .chat-form input{flex:1;padding:10px 12px;border-radius:10px;border:1px solid #ffffff25;background:rgba(255,255,255,.03);color:inherit}
    .primary{background:#3b82f6;border:0;color:#fff;border-radius:10px;padding:10px 16px}
    .ghost{background:transparent;border:1px solid #ffffff33;color:inherit;border-radius:10px;padding:10px 12px}
    .danger{border-color:#ff6868;color:#ff9b9b}
    .label{opacity:.7}
    .value{font-weight:800}
    .big-mic{font-size:22px;padding:12px 14px}
    .foot{opacity:.6;text-align:center;margin-top:10px}
    .hint{opacity:.6;margin-top:8px}
    .tts-row{display:flex;gap:8px;align-items:center;margin-top:8px}
    .spacer{flex:1}
    .error-badge{position:fixed;right:12px;bottom:12px;background:#ff4d4f;color:#fff;padding:8px 10px;border-radius:8px;font-size:12px;display:none;z-index:9999}
  </style>
</head>
<body>
  <main class="container">
    <!-- ìƒë‹¨ ì¸ì‚¬/ì‹œê³„ -->
    <section class="hero">
      <div>
        <h1 id="greet">ì‹œì¥ë‹˜ ì•ˆë…•í•˜ì„¸ìš”</h1>
        <p class="sub" id="today">YYYY.MM.DD (ìš”ì¼)</p>
      </div>
      <div class="clock" id="clock">--:--</div>
    </section>

    <!-- ë‚ ì”¨ -->
    <section class="card">
      <header class="card-title">í˜„ì¬ ë‚ ì”¨</header>
      <div class="row" style="justify-content:space-between">
        <div class="row" style="gap:32px">
          <div><span class="label">ì˜¨ë„</span>: <span id="temp" class="value">-â„ƒ</span></div>
          <div><span class="label">ìŠµë„</span>: <span id="reh" class="value">-%</span></div>
          <div><span class="label">ê°•ìˆ˜(1h)</span>: <span id="rn1" class="value">- mm</span></div>
          <div><span class="label">í’ì†</span>: <span id="wsd" class="value">- m/s</span></div>
        </div>
        <button id="btnWx" class="ghost">ë‚ ì”¨ ì—…ë°ì´íŠ¸</button>
      </div>
    </section>

    <div class="grid2">
      <!-- AI ë¹„ì„œ -->
      <section class="card">
        <header class="card-title">AI ë¹„ì„œ ì±„íŒ…</header>
        <div id="chat" class="chat">
          <div class="bot">ì•ˆë…•í•˜ì„¸ìš”, ì‹œì¥ë‹˜. ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?</div>
        </div>

        <form id="chatForm" class="chat-form">
          <button type="button" id="micBtn" title="ìŒì„±ìœ¼ë¡œ ë§í•˜ê¸°" class="ghost big-mic">ğŸ¤</button>
          <input id="msgInput" type="text" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”. (ì˜ˆ: ì˜¤ëŠ˜ ì¼ì • ìš”ì•½)" autocomplete="off" />
          <button type="submit" class="primary">ë³´ë‚´ê¸°</button>
        </form>

        <div class="tts-row">
          <label><input type="checkbox" id="ttsToggle" checked /> ì‘ë‹µì„ ìŒì„±ìœ¼ë¡œ ì½ê¸°</label>
          <div class="spacer"></div>
          <button id="ttsPause" class="ghost">â¸ï¸ ì¼ì‹œì •ì§€</button>
          <button id="ttsResume" class="ghost">â–¶ï¸ ì¬ê°œ</button>
          <button id="ttsStop" class="danger ghost">â–  ì •ì§€</button>
        </div>
        <p class="hint">â€» íŠ¹ìˆ˜ë¬¸ì/ì´ëª¨ì§€/ë§ˆí¬ë‹¤ìš´ ë“±ì€ ì½ê¸° ì „ì— ìë™ ì •ë¦¬ë©ë‹ˆë‹¤.</p>
      </section>

      <!-- ì‹¤ì‹œê°„ í†µì—­ -->
      <section class="card">
        <header class="card-title">ì‹¤ì‹œê°„ í†µì—­</header>
        <div class="row">
          <span class="label">ì…ë ¥(ë§í•˜ê¸°) ì–¸ì–´</span>
          <select id="langIn"></select>
          <span class="label">ì¶œë ¥(ì½ì–´ì£¼ê¸°) ì–¸ì–´</span>
          <select id="langOut"></select>
          <div class="spacer"></div>
          <button id="btnTrStart" class="primary">í†µì—­ ì‹œì‘</button>
          <button id="btnTrStop" class="ghost danger">í†µì—­ ì •ì§€</button>
        </div>
        <div id="trArea" class="chat" style="height:180px;margin-top:10px">
          <div class="bot">[tip] ë§ˆì´í¬ ê¶Œí•œ í—ˆìš© í›„ â€œí†µì—­ ì‹œì‘â€ì„ ëˆ„ë¥´ê³  ë§ì”€í•´ ì£¼ì„¸ìš”.</div>
        </div>
        <div class="row" style="margin-top:8px">
          <button id="btnSpeakLast" class="ghost">ğŸ”Š ë§ˆì§€ë§‰ ë²ˆì—­ ì½ê¸°</button>
          <span id="trStatus" class="hint">(ëŒ€ê¸° ì¤‘)</span>
        </div>
      </section>
    </div>

    <footer class="foot">Â© ë…¼ì‚°ì‹œ ìŠ¤ë§ˆíŠ¸ë¯¸ëŸ¬ Â· ë£¨ë¯¸ë‚˜ PRO</footer>
  </main>

  <!-- ì—ëŸ¬ ë°°ì§€ -->
  <div id="errorBadge" class="error-badge">ë¬¸ì œ ê°ì§€ Â· íŒ€ì— ë³´ê³ ë¨</div>

  <!-- AI/í†µì—­ ìœ í‹¸ (export ì—†ì´ ì „ì—­ attach â†’ ë¸Œë¼ìš°ì € SyntaxError ë°©ì§€) -->
  <script src="/ai.js"></script>

  <script>
    const $ = (s) => document.querySelector(s);

    // ---------------- ì‹œê°„/ë‚ ì§œ ----------------
    function tick(){
      const now = new Date();
      $('#clock').textContent = now.toLocaleTimeString
('ko-KR',{hour:'2-digit',minute:'2-digit'});
      $('#today').textContent = now.toLocaleDateString
('ko-KR',{year:'numeric',month:'2-digit',day:'2-digit',weekday:'long'});
    }
    setInterval(tick,1000); tick();

    // ---------------- ë‚ ì”¨ ----------------
    async function loadWeather() {
      try{
        const r = await fetch('/api/weather');
        const d = await r.json();
        if (d && d.ok){
          $('#temp').textContent = (d.tempC ?? '-') + 'â„ƒ';
          $('#reh').textContent  = (d.reh ?? '-') + '%';
          $('#rn1').textContent  = (d.rn1 ?? '-') + ' mm';
          $('#wsd').textContent  = (d.wsd ?? '-') + ' m/s';
        } else {
          throw new Error('no ok');
        }
      }catch(e){
        $('#temp').textContent='-â„ƒ'; $('#reh').textContent='-%'; $('#rn1').textContent='- mm'; $('#wsd').textContent='- m/s';
      }
    }
    $('#btnWx').onclick = loadWeather;
    loadWeather();

    // ---------------- ì±„íŒ… ----------------
    const chat = $('#chat'); const input = $('#msgInput'); const form = $('#chatForm');
    function pushMsg(role, text){
      const div = document.createElement('div');
      div.className = role === 'user' ? 'user' : 'bot';
      div.textContent = text;
      chat.appendChild
(div);
      chat.scrollTop = chat.scrollHeight;
    }

    async function callAI(prompt){
      if (typeof window.askAI === 'function') return await window.askAI(prompt);
      // í´ë°±(ì„œë²„ ì—†ìœ¼ë©´ ì—ì½”)
      return 'ë„¤, "'+prompt+'"ì— ëŒ€í•´ í™•ì¸í–ˆìŠµë‹ˆë‹¤.';
    }

    form.addEventListener
('submit', async (e)=>{
      e.preventDefault();
      const q = input.value.trim(); if(!q) return;
      input.value=''; pushMsg('user', q);
      try{
        const a = await callAI(q);
        pushMsg('bot', a); speak(a);
      }catch{
        const msg='ì—ëŸ¬ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.'; pushMsg('bot', msg); speak(msg);
      }
    });

    // ---------------- ìŒì„± í•©ì„± TTS ----------------
    const ttsToggle=$('#ttsToggle'), ttsPause=$('#ttsPause'), ttsResume=$('#ttsResume'), ttsStop=$('#ttsStop');
    function speak(text){
      if(!ttsToggle.checked) return;
      const line = (window.sanitizeForTTS||((s)=>s))(text);
      if(!line) return;
      speechSynthesis.cancel
();
      const u = new SpeechSynthesisUtterance(line);
      u.lang = 'ko-KR'; u.rate=1.0; u.pitch=1.0;
      speechSynthesis.speak(u);
    }
    ttsPause.onclick=()=>speechSynthesis.pause();
    ttsResume.onclick=()=>speechSynthesis.resume();
    ttsStop.onclick=()=>speechSynthesis.cancel
();

    // ---------------- ìŒì„± ì¸ì‹ STT ----------------
    let rec=null;
    if('webkitSpeechRecognition' in window){
      const R = window.webkitSpeechRecognition;
      rec = new R(); rec.lang='ko-KR'; rec.continuous
=false; rec.interimResults
=false;
      rec.onresult=(e)=>{ input.value=e.results[0][0].transcript; form.dispatchEvent(new Event('submit',{cancelable:true})); };
      rec.onerror=()=>alert('ìŒì„± ì¸ì‹ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      $('#micBtn').onclick=()=>{ try{ rec.start(); }catch(_){} };
    }else{
      $('#micBtn').disabled = true; $('#micBtn').title='ì´ ë¸Œë¼ìš°ì €ëŠ” ìŒì„± ì¸ì‹ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.';
    }

    // ---------------- ì‹¤ì‹œê°„ í†µì—­ ----------------
    const LANGS = window.TR_LANGS;      // ai.jsì—ì„œ ì œê³µ
    const tr = $('#trArea'), st = $('#trStatus'), selIn=$('#langIn'), selOut=$('#langOut');
    for (const [code, name] of LANGS) {
      const o1=document.createElement('option'); o1.value=code; o1.textContent=name; selIn.appendChild
(o1);
      const o2=document.createElement('option'); o2.value=code; o2.textContent=name; selOut.appendChild
(o2);
    }
    selIn.value='ko'; selOut.value='en';

    let recTr=null, lastTranslated='';
    function pushTr(role, text){
      const div=document.createElement('div'); div.className=role==='me'?'user':'bot'; div.textContent=text; tr.appendChild(div); tr.scrollTop=tr.scrollHeight;
    }
    async function translateAndSpeak(text, from, to){
      const out = await (window.translateText ? window.translateText(text, from, to) : Promise.resolve(text));
      lastTranslated = out; pushTr('bot', `[${to}] ${out}`);
      const u = new SpeechSynthesisUtterance(out); u.lang = window.langToVoice[to] || 'en-US'; speechSynthesis.speak(u);
    }
    $('#btnSpeakLast').onclick=()=>{ if(!lastTranslated) return; const u=new SpeechSynthesisUtterance(lastTranslated); u.lang=window.langToVoice[selOut.value]||'en-US'; speechSynthesis.speak(u); };

    $('#btnTrStart').onclick=()=>{
      if(!('webkitSpeechRecognition' in window)){ alert('ë¸Œë¼ìš°ì €ê°€ ì‹¤ì‹œê°„ í†µì—­ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.'); return; }
      if(recTr) return;
      const R = window.webkitSpeechRecognition;
      recTr = new R(); recTr.lang = window.langToVoice[selIn.value] || 'ko-KR'; recTr.continuous
=true; recTr.interimResults
=false;
      recTr.onresult = async (e)=>{ const txt=e.results[e.results.length-1][0].transcript; pushTr('me', `[${selIn.value}] ${txt}`); try{ await translateAndSpeak(txt, selIn.value, selOut.value);}catch{ pushTr('bot','(í†µì—­ ì˜¤ë¥˜)'); } };
      recTr.onstart=()=>{ st.textContent='(í†µì—­ ì¤‘)'; pushTr('bot','ğŸ¤ í†µì—­ ì‹œì‘'); };
      recTr.onend=()=>{ st.textContent='(ëŒ€ê¸° ì¤‘)'; pushTr('bot','â¹ í†µì—­ ì¢…ë£Œ'); recTr=null; };
      try{ recTr.start(); }catch{}
    };
    $('#btnTrStop').onclick=()=>{ try{ recTr && recTr.stop(); }catch{} };

    // ---------------- ì—ëŸ¬ ìë™ ë±ƒì§€ ----------------
    function showErr(){ document.getElementById('errorBadge').style.display='block'; }
    window.addEventListener
('error', showErr);
    window.addEventListener
('unhandledrejection', showErr);
  </script>
</body>
</html>
