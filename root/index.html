<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ì‹œì¥ë‹˜ ì§‘ë¬´ì‹¤ Â· ìŠ¤ë§ˆíŠ¸ ë¯¸ëŸ¬ PRO</title>

  <!-- PWA -->
  <link rel="manifest" href="/manifest.webmanifest" />
  <link rel="icon" sizes="192x192" href="/icon-192.png" />
  <link rel="icon" sizes="512x512" href="/icon-512.png" />
  <meta name="theme-color" content="#0b0f19" />

  <link rel="stylesheet" href="/style.css" />
</head>
<body>
<main class="container">
  <!-- ìƒë‹¨ ì¸ì‚¬/ì‹œê³„ -->
  <section class="hero">
    <div>
      <h1 id="greet">í™œê¸°ì°¬ í•˜ë£¨ì…ë‹ˆë‹¤, ì‹œì¥ë‹˜</h1>
      <p class="sub" id="today"></p>
    </div>
    <div class="clock" id="clock">--:--</div>
  </section>

  <!-- AI ë¹„ì„œ (ì±„íŒ… + ìŒì„±) -->
  <section class="card">
    <header class="card-title">AI ë¹„ì„œ (ì±„íŒ… + ìŒì„±)</header>

    <div id="chat" class="chat">
      <div class="bot">ì•ˆë…•í•˜ì„¸ìš”, ì‹œì¥ë‹˜. ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?</div>
    </div>

    <form id="chatForm" class="chat-form">
      <button type="button" id="micBtn" title="ìŒì„±ìœ¼ë¡œ ë§í•˜ê¸°" class="ghost">ğŸ¤</button>
      <input id="msgInput" type="text" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”. (ì˜ˆ: ì˜¤ëŠ˜ ì¼ì • ìš”ì•½)" autocomplete="off" />
      <button type="submit" class="primary">ë³´ë‚´ê¸°</button>
    </form>

    <div class="tts-row">
      <label><input type="checkbox" id="ttsToggle" checked /> ì‘ë‹µì„ ìŒì„±ìœ¼ë¡œ ì½ê¸°</label>
      <div class="spacer"></div>
      <button id="ttsPause" class="ghost">â¸ï¸ ì¼ì‹œì •ì§€</button>
      <button id="ttsResume" class="ghost">â–¶ï¸ ì¬ê°œ</button>
      <button id="ttsStop" class="danger ghost">â–  ì •ì§€</button>
    </div>

    <p class="hint">â€» íŠ¹ìˆ˜ë¬¸ì/ì´ëª¨ì§€/ë§ˆí¬ë‹¤ìš´ ë“±ì€ ì½ê¸° ì „ì— ìë™ ì •ë¦¬ë©ë‹ˆë‹¤.</p>
  </section>

  <!-- ë°”ë‹¥ í‘œì‹œ -->
  <footer class="footer">Â© ë…¼ì‚°ì‹œ ìŠ¤ë§ˆíŠ¸ë¯¸ëŸ¬ Â· ë£¨ë¯¸ë‚˜ PRO</footer>
</main>

<!-- ì—ëŸ¬ ë°°ì§€ -->
<style>
  .error-badge{position:fixed;right:12px;bottom:12px;background:#ff4d4f;color:#fff;padding:8px 10px;border-radius:8px;font-size:12px;display:none;z-index:9999}
</style>
<div id="errorBadge" class="error-badge">ë¬¸ì œ ê°ì§€ Â· íŒ€ì— ë³´ê³ ë¨</div>

<!-- AI ë¡œì§ -->
<script src="/ai.js"></script>

<script>
  // ========= DOM ë‹¨ì¶• =========
  const $ = (s)=>document.querySelector(s);
  const chat = $('#chat');
  const input = $('#msgInput');
  const form = $('#chatForm');
  const micBtn = $('#micBtn');
  const ttsToggle = $('#ttsToggle');
  const ttsPause = $('#ttsPause');
  const ttsResume = $('#ttsResume');
  const ttsStop = $('#ttsStop');

  // ========= ì‹œê³„/ë‚ ì§œ =========
  function tick(){
    const now = new Date();
    $('#clock').textContent = now.toLocaleTimeString
('ko-KR',{hour:'2-digit',minute:'2-digit'});
    $('#today').textContent = now.toLocaleDateString
('ko-KR',{year:'numeric',month:'2-digit',day:'2-digit',weekday:'long'});
  }
  setInterval(tick,1000); tick();

  // ========= ì±„íŒ… ë§í’ì„  =========
  function pushMsg(role, text){
    const div = document.createElement('div');
    div.className = role==='user' ? 'user' : 'bot';
    div.textContent = text;
    chat.appendChild
(div);
    chat.scrollTop = chat.scrollHeight;
  }

  // ========= TTS(íŠ¹ìˆ˜ë¬¸ì/ì´ëª¨ì§€ ì •ë¦¬) =========
  function sanitizeForTTS(text){
    return (text??'')
      .replace(/https?:\/\/\S+/g,' ')               // URL ì œê±°
      .replace(/[#*_`>~|[\](){}/+\-=]/g,' ')        // ë§ˆí¬ë‹¤ìš´/ê¸°í˜¸ ì œê±°
      .replace(/[\uD800-\uDBFF][\uDC00-\uDFFF]/g,' ')// ì„œëŸ¬ê²Œì´íŠ¸ ìŒ(ì´ëª¨ì§€) ì œê±°
      .replace(/\s+/g,' ').trim();
  }
  function speak(text){
    if(!ttsToggle.checked) return;
    const line = sanitizeForTTS(text);
    if(!line) return;
    speechSynthesis.cancel
();
    const u = new SpeechSynthesisUtterance(line);
    u.lang='ko-KR'; u.rate=1.0; u.pitch=1.0;
    speechSynthesis.speak(u);
  }
  ttsPause.onclick = ()=>speechSynthesis.pause();
  ttsResume.onclick = ()=>speechSynthesis.resume();
  ttsStop.onclick = ()=>speechSynthesis.cancel
();

  // ========= STT =========
  let rec;
  if('webkitSpeechRecognition' in window){
    const R = window.webkitSpeechRecognition;
    rec = new R();
    rec.lang='ko-KR'; rec.continuous
=false; rec.interimResults
=false;
    rec.onresult = (e)=>{
      const txt = e.results[0][0].transcript;
      input.value = txt;
      form.dispatchEvent(new Event('submit',{cancelable:true}));
    };
    rec.onerror = ()=>alert('ìŒì„± ì¸ì‹ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.');
  }else{
    micBtn.disabled = true;
    micBtn.title = 'ë¸Œë¼ìš°ì €ê°€ ìŒì„± ì¸ì‹ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.';
  }
  micBtn.onclick = ()=>{ try{ rec && rec.start(); }catch(_){} };

  // ========= AI í˜¸ì¶œ =========
  async function callAI(prompt){
    if(typeof window.askAI==='function'){  // /ai.js ì œê³µ ì‹œ ìš°ì„  ì‚¬ìš©
      return await window.askAI(prompt);
    }
    const res = await fetch('/api/ai',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({prompt})
    });
    if(!res.ok) throw new Error('AI ì‘ë‹µ ì‹¤íŒ¨');
    const data = await res.json();
    return data.text || data.reply || JSON.stringify(data);
  }

  // ========= ì „ì†¡ ì²˜ë¦¬ =========
  form.addEventListener
('submit', async (e)=>{
    e.preventDefault();
    const q = input.value.trim();
    if(!q) return;
    input.value='';
    pushMsg('user', q);
    try{
      const a = await callAI(q);
      pushMsg('bot', a);
      speak(a);
    }catch(err){
      const msg='ì—ëŸ¬ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ê³§ ì¡°ì¹˜í•˜ê² ìŠµë‹ˆë‹¤.';
      pushMsg('bot', msg);
      speak(msg);
    }
  });

  // ========= ì—ëŸ¬ ë°°ì§€ =========
  function showErr(){ $('#errorBadge').style.display='block'; }
  window.addEventListener
('error', showErr);
  window.addEventListener
('unhandledrejection', showErr);
</script>
</body>
</html>
