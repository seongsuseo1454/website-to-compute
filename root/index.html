<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>시장님 집무실 · 스마트 미러 PRO</title>

  <!-- PWA -->
  <link rel="manifest" href="/manifest.webmanifest" />
  <link rel="icon" sizes="192x192" href="/icon-192.png" />
  <link rel="icon" sizes="512x512" href="/icon-512.png" />
  <meta name="theme-color" content="#0b0f19" />

  <link rel="stylesheet" href="/style.css" />
</head>
<body>
<main class="container">
  <!-- 상단 인사/시계 -->
  <section class="hero">
    <div>
      <h1 id="greet">활기찬 하루입니다, 시장님</h1>
      <p class="sub" id="today"></p>
    </div>
    <div class="clock" id="clock">--:--</div>
  </section>

  <!-- 현재 건강·업무 요약 -->
  <section class="grid">
    <div class="card">
      <header class="card-title">오늘 핵심 지표</header>
      <div class="kpis">
        <div class="kpi"><div class="kpi-v" id="step">8,420</div><div class="kpi-n">걸음수</div></div>
        <div class="kpi"><div class="kpi-v" id="sleep">7.2h</div><div class="kpi-n">수면</div></div>
        <div class="kpi"><div class="kpi-v" id="hr">68</div><div class="kpi-n">심박수</div></div>
      </div>
      <p class="hint">* 실 장비 미연결 상태 – 데모 값 표시</p>
    </div>

    <div class="card">
      <header class="card-title">날씨 & 특보</header>
      <div class="weather">
        <div class="now">
          <div class="temp" id="temp">--°C</div>
          <div class="meta">
            <div>습도 <span id="hum">-%</span></div>
            <div>풍속 <span id="wind">- m/s</span></div>
          </div>
        </div>
        <div class="tools">
          <button id="wxRefresh" class="ghost">날씨 업데이트</button>
        </div>
      </div>
      <div class="badges">
        <button class="badge ghost">날씨 새로고침</button>
        <button class="badge ghost">태풍 특보(데모)</button>
      </div>
    </div>
  </section>

  <!-- 오늘 일정 요약 -->
  <section class="card">
    <header class="card-title">오늘 일정 요약</header>
    <ul class="agenda" id="agenda">
      <li><span class="t">10:00</span> 간부 회의 <span class="loc">본관 3층 상황실</span></li>
      <li><span class="t">14:00</span> 지역 기업 대표 면담 <span class="loc">시장 집무실</span></li>
      <li><span class="t">17:00</span> 청소년 진로 간담회 <span class="loc">시립도서관</span></li>
    </ul>
    <div class="tools"><button class="ghost">새로고침</button></div>
  </section>

  <!-- AI 비서 (채팅 + 음성) -->
  <section class="card">
    <header class="card-title">AI 비서 (채팅 + 음성)</header>

    <div id="chat" class="chat">
      <div class="bot">안녕하세요, 시장님. 무엇을 도와드릴까요?</div>
    </div>

    <form id="chatForm" class="chat-form">
      <button type="button" id="micBtn" title="음성으로 말하기" class="ghost">🎤</button>
      <input id="msgInput" type="text" placeholder="메시지를 입력하세요. (예: 오늘 일정 요약)" autocomplete="off" />
      <button type="submit" class="primary">보내기</button>
    </form>

    <div class="tts-row">
      <label><input type="checkbox" id="ttsToggle" checked /> 응답을 음성으로 읽기</label>
      <div class="spacer"></div>
      <button id="ttsPause" class="ghost">⏸︎ 일시정지</button>
      <button id="ttsResume" class="ghost">▶︎ 재개</button>
      <button id="ttsStop" class="danger ghost">■ 정지</button>
    </div>

    <p class="hint">※ 특수문자/이모지/마크다운 등은 읽기 전에 자동 정리됩니다.</p>
  </section>

  <!-- 바닥 표시 -->
  <footer class="footer">© 논산시 스마트미러 · 루미나 PRO</footer>
</main>

<!-- 에러 배지 -->
<style>.error-badge{position:fixed;right:12px;bottom:12px;background:#ff4d4f;color:#fff;padding:8px 10px;border-radius:8px;font-size:12px;display:none;z-index:9999}</style>
<div id="errorBadge" class="error-badge">문제 감지 · 팀에 보고됨</div>

<!-- 앱 스크립트 -->
<script type="module" src="/ai.js"></script>
<script>
  // 인사/시계
  const $ = (s)=>document.querySelector(s);
  function tick(){
    const now=new Date();
    $('#clock').textContent = now.toLocaleTimeString
('ko-KR',{hour:'2-digit',minute:'2-digit'});
    $('#today').textContent = now.toLocaleDateString
('ko-KR',{year:'numeric',month:'2-digit',day:'2-digit',weekday:'long'});
  }
  tick(); setInterval(tick,1000);

  // 간단 날씨 데모 + 업데이트 버튼
  const NX = 60, NY = 127; // 필요 시 기상청 격자 좌표로 교체
  async function refreshWeather(){
    try{
      const date=new Date();
      const d = date.toISOString
().slice(0,10).replace(/-/g,'');
      const t = String(date.getHours()).padStart(2,'0')+'00';
      const res = await fetch(`/api/weather?nx=${NX}&ny=${NY}&date=${d}&time=${t}&type=JSON`);
      if(!res.ok) throw new Error('WEATHER_API_FAIL');
      const data = await res.json();

      // 데이터 구조에 맞춰 가공 (실패 시 데모 유지)
      const temp = data?.temp ?? 26;
      const hum  = data?.humidity ?? 58;
      const wind = data?.wind ?? 1.8;

      $('#temp').textContent = `${temp}°C`;
      $('#hum').textContent = `${hum}%`;
      $('#wind').textContent = `${wind} m/s`;
    }catch(e){
      // 데모 값 유지
      $('#temp').textContent = '26°C';
      $('#hum').textContent = '58%';
      $('#wind').textContent = '1.8 m/s';
    }
  }
  refreshWeather();
  $('#wxRefresh').addEventListener('click', refreshWeather);

  // 전역 에러 배지
  const badge = document.getElementById('errorBadge');
  window.addEventListener
('error', ()=>badge.style.display='block');
  window.addEventListener
('unhandledrejection', ()=>badge.style.display='block');
</script>
</body>
</html>
