<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ì‹œì¥ë‹˜ ì§‘ë¬´ì‹¤ Â· ìŠ¤ë§ˆíŠ¸ ë¯¸ëŸ¬ PRO</title>

  <!-- PWA -->
  <link rel="manifest" href="/manifest.webmanifest" />
  <link rel="icon" sizes="192x192" href="/icon-192.png" />
  <link rel="icon" sizes="512x512" href="/icon-512.png" />
  <meta name="theme-color" content="#0b0f19" />

  <link rel="stylesheet" href="/style.css" />
</head>
<body>
<main class="container">
  <!-- ìƒë‹¨ ì¸ì‚¬/ì‹œê³„ -->
  <section class="hero">
    <div>
      <h1 id="greet">ì‹œì¥ë‹˜ ì•ˆë…•í•˜ì„¸ìš”</h1>
      <p class="sub" id="today"></p>
    </div>
    <div class="clock" id="clock">--:--</div>
  </section>

  <!-- í˜„ì¬ ë‚ ì”¨ (ëª¨ë°”ì¼ ìš°ì„ , ì¢Œí‘œ ë¬¸êµ¬ ì œê±°) -->
  <section class="card">
    <div class="card-head">
      <h2 class="card-title">í˜„ì¬ ë‚ ì”¨</h2>
      <button id="btnWeather" class="btn ghost">ë‚ ì”¨ ì—…ë°ì´íŠ¸</button>
    </div>

    <!-- ë‚´ë¶€ ì§„ë‹¨ìš© sourceë§Œ ë³´ê´€, í™”ë©´í‘œì‹œëŠ” ìˆ¨ê¹€ -->
    <p id="weatherMeta" class="meta" hidden></p>

    <div class="kv-grid">
      <div class="kv"><span class="k">ì˜¨ë„</span><span class="v"><span id="temp">-</span>Â°C</span></div>
      <div class="kv"><span class="k">ìŠµë„</span><span class="v"><span id="hum">-</span>%</span></div>
      <div class="kv"><span class="k">ê°•ìˆ˜</span><span class="v"><span id="rain">-</span></span></div>
      <div class="kv"><span class="k">í’ì†</span><span class="v"><span id="wind">-</span> m/s</span></div>
    </div>
  </section>

  <!-- AI ë¹„ì„œ (ì±„íŒ… + ìŒì„±) -->
  <section class="card">
    <h2 class="card-title">AI ë¹„ì„œ ì±„íŒ…</h2>

    <div id="chat" class="chat">
      <div class="bot">ì•ˆë…•í•˜ì„¸ìš”, ì‹œì¥ë‹˜. ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?</div>
    </div>

    <form id="chatForm" class="chat-form">
      <button type="button" id="micBtn" title="ìŒì„±ìœ¼ë¡œ ë§í•˜ê¸°" class="ghost mic">ğŸ¤</button>
      <input id="msgInput" type="text" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”. (ì˜ˆ: ì˜¤ëŠ˜ ì¼ì • ìš”ì•½)" autocomplete="off" />
      <button type="submit" class="primary">ë³´ë‚´ê¸°</button>
    </form>

    <div class="tts-row">
      <label class="ck"><input type="checkbox" id="ttsToggle" checked /> ì‘ë‹µì„ ìŒì„±ìœ¼ë¡œ ì½ê¸°</label>
      <div class="spacer"></div>
      <button id="ttsPause" class="ghost">â¸ï¸ ì¼ì‹œì •ì§€</button>
      <button id="ttsResume" class="ghost">â–¶ï¸ ì¬ê°œ</button>
      <button id="ttsStop" class="danger ghost">â–  ì •ì§€</button>
    </div>

    <p class="hint">â€» íŠ¹ìˆ˜ë¬¸ì/ì´ëª¨ì§€/ë§ˆí¬ë‹¤ìš´ ë“±ì€ ì½ê¸° ì „ì— ìë™ ì •ë¦¬ë©ë‹ˆë‹¤.</p>
  </section>

  <footer class="footer">Â© ë…¼ì‚°ì‹œ ìŠ¤ë§ˆíŠ¸ë¯¸ëŸ¬ Â· ë£¨ë¯¸ë‚˜ PRO</footer>
</main>

<!-- ë¹„ì„œ ë¡œì§ -->
<script type="module">
  // ---- ê³µí†µ ì…€ë ‰í„°
  const $ = (s) => document.querySelector(s);

  // ---- ì‹œê³„/ë‚ ì§œ
  function tick() {
    const now = new Date();
    $('#clock').textContent = now.toLocaleTimeString
('ko-KR', { hour: '2-digit', minute: '2-digit' });
    $('#today').textContent = now.toLocaleDateString
('ko-KR', { year:'numeric', month:'2-digit', day:'2-digit', weekday:'long' });
  }
  setInterval(tick, 1000); tick();

  // ---- ì±„íŒ… UI
  const chat = $('#chat');
  const form = $('#chatForm');
  const input = $('#msgInput');
  const micBtn = $('#micBtn');

  function pushMsg(role, text) {
    const div = document.createElement('div');
    div.className = role === 'user' ? 'user' : 'bot';
    div.textContent = text;
    chat.appendChild
(div);
    chat.scrollTop = chat.scrollHeight;
  }

  // ---- ìŒì„± í•©ì„±(TTS) (íŠ¹ìˆ˜ë¬¸ì ìë™ ì •ë¦¬)
  const ttsToggle = $('#ttsToggle');
  const ttsPause  = $('#ttsPause');
  const ttsResume = $('#ttsResume');
  const ttsStop   = $('#ttsStop');

  function sanitizeForTTS(s) {
    s = String(s ?? '');
    s = s.replace(/https?:\/\/\S+/g, ' ');
    s = s.replace(/[\*\_\`\~\^\#\>\<\|\:\\\/\[\]\{\}\-]+/g, ' ');
    try { s = s.replace(/\p{Extended_Pictographic}/gu, ''); } catch {}
    s = s.replace(/[\u0000-\u001F\u007F-\u009F]/g, ' ');
    return s.replace(/\s{2,}/g, ' ').trim();
  }
  function speak(text) {
    if (!ttsToggle.checked) return;
    const line = sanitizeForTTS(text);
    if (!line) return;
    speechSynthesis.cancel
();
    const u = new SpeechSynthesisUtterance(line);
    u.lang = 'ko-KR'; u.rate = 1; u.pitch = 1;
    speechSynthesis.speak(u);
  }
  ttsPause.onclick  = () => speechSynthesis.pause();
  ttsResume.onclick = () => speechSynthesis.resume();
  ttsStop.onclick   = () => speechSynthesis.cancel
();

  // ---- ìŒì„± ì…ë ¥(STT)
  let rec;
  if ('webkitSpeechRecognition' in window) {
    const R = window.webkitSpeechRecognition;
    rec = new R(); rec.lang = 'ko-KR'; rec.continuous
 = false; rec.interimResults
 = false;
    rec.onresult = (e) => {
      input.value = e.results[0][0].transcript;
      form.requestSubmit();
    };
  } else {
    micBtn.disabled = true;
    micBtn.title = 'ì´ ë¸Œë¼ìš°ì €ëŠ” ìŒì„± ì¸ì‹ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.';
  }
  micBtn.onclick = () => { try { rec && rec.start(); } catch {} };

  // ---- AI í˜¸ì¶œ(ìˆìœ¼ë©´ askAI, ì—†ìœ¼ë©´ /api/ai)
  async function callAI(prompt) {
    if (typeof window.askAI === 'function') return await window.askAI(prompt);
    const r = await fetch('/api/ai', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ prompt }) });
    if (!r.ok) throw new Error('AI ì˜¤ë¥˜ ' + r.status);
    const j = await r.json();
    return j.text || j.reply || JSON.stringify(j);
  }

  form.addEventListener
('submit', async (e) => {
    e.preventDefault();
    const q = input.value.trim(); if (!q) return;
    input.value = ''; pushMsg('user', q);
    try {
      const a = await callAI(q);
      pushMsg('bot', a); speak(a);
    } catch {
      const msg = 'ì—ëŸ¬ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ê³§ ì¡°ì¹˜í•˜ê² ìŠµë‹ˆë‹¤.';
      pushMsg('bot', msg); speak(msg);
    }
  });

  // ---- ë‚ ì”¨ ê°±ì‹ (/api/weather: {temp,humidity,wind,rain,source})
  async function refreshWeather() {
    try {
      const r = await fetch('/api/weather');
      if (!r.ok) throw new Error('HTTP '+r.status);
      const d = await r.json();
      $('#temp').textContent = d.temp ?? '-';
      $('#hum').textContent  = d.humidity ?? '-';
      $('#wind').textContent = d.wind ?? '-';
      $('#rain').textContent = d.rain ?? '-';
      if (d.source) { const m = $('#weatherMeta'); m.textContent = d.source; m.hidden = true; }
    } catch {
      // ê°’ì´ ì—†ìœ¼ë©´ ê·¸ëŒ€ë¡œ '-' ìœ ì§€
    }
  }
  $('#btnWeather').onclick = refreshWeather;
  refreshWeather();
</script>

<!-- (ì„ íƒ) ai.jsê°€ ìˆìœ¼ë©´ ìë™ ë¡œë“œ -->
<script src="/ai.js" defer></script>
</body>
</html>
