<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ì‹œì¥ë‹˜ ì§‘ë¬´ì‹¤ Â· ìŠ¤ë§ˆíŠ¸ ë¯¸ëŸ¬ PRO</title>

  <!-- PWA -->
  <link rel="manifest" href="/manifest.webmanifest" />
  <link rel="icon" sizes="192x192" href="/icon-192.png" />
  <link rel="icon" sizes="512x512" href="/icon-512.png" />
  <meta name="theme-color" content="#0b0f19" />

  <link rel="stylesheet" href="/style.css" />
  <style>
    /* ìµœì†Œ ë³´ì¥ ìŠ¤íƒ€ì¼ (ê¸°ì¡´ style.cssê°€ ìˆìœ¼ë©´ ê·¸ëŒ€ë¡œ ì ìš©ë¨) */
    body{background:#0b0f19;color:#e6e9f0;font-family:system-ui,apple sd gothi,Segoe UI,Roboto,Apple SD Gothic Neo,Malgun Gothic,sans-serif}
    .container{max-width:980px;margin:24px auto;padding:8px}
    .hero{display:flex;justify-content:space-between;align-items:center;background:#141927;border:1px solid #2a3345;border-radius:16px;padding:20px 24px;margin-bottom:16px}
    .hero h1{font-size:32px;margin:0 0 6px}
    .hero .sub{opacity:.8;margin:0}
    .clock{font-size:40px;opacity:.9}
    .card{background:#141927;border:1px solid #2a3345;border-radius:16px;padding:16px 18px;margin-bottom:16px}
    .card-title{font-size:22px;margin:0 0 14px}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .pill{display:inline-flex;align-items:center;gap:8px;border:1px solid #39445f;background:#1a2131;padding:8px 12px;border-radius:12px}
    .chat{display:flex;flex-direction:column;gap:10px;height:260px;overflow:auto;background:#0f1321;border:1px solid #2a3345;border-radius:12px;padding:12px}
    .chat .user{align-self:flex-end;background:#21406b;padding:10px 12px;border-radius:12px 12px 2px 12px}
    .chat .bot{align-self:flex-start;background:#222b43;padding:10px 12px;border-radius:12px 12px 12px 2px}
    .chat-form{display:flex;gap:8px;margin-top:10px}
    .chat-form input{flex:1;background:#0f1321;border:1px solid #2a3345;border-radius:10px;padding:10px;color:#e6e9f0}
    button{cursor:pointer}
    .primary{background:#3b82f6;border:0;color:#fff;border-radius:10px;padding:10px 14px}
    .ghost{background:#1b2234;border:1px solid #2a3345;color:#cbd5e1;border-radius:10px;padding:10px 12px}
    .danger{border-color:#8b2f37;color:#ffdfe1}
    .spacer{flex:1}
    .tts-row{display:flex;align-items:center;gap:10px;margin-top:8px}
    .footer{opacity:.7;text-align:center;margin:20px 0}
    .grid{display:grid;grid-template-columns:1fr;gap:16px}
    @media (min-width:800px){ .grid{grid-template-columns:1fr 1fr} }
    .error-badge{position:fixed;right:12px;bottom:12px;background:#ff4d4f;color:#fff;padding:8px 10px;border-radius:8px;font-size:12px;display:none;z-index:9999}
  </style>
</head>
<body>
<main class="container">
  <!-- ìƒë‹¨ ì¸ì‚¬/ì‹œê³„ -->
  <section class="hero">
    <div>
      <h1 id="greet">í™œê¸°ì°¬ í•˜ë£¨ì…ë‹ˆë‹¤, ì‹œì¥ë‹˜</h1>
      <p class="sub" id="today">YYYY.MM.DD (ìš”ì¼)</p>
    </div>
    <div class="clock" id="clock">--:--</div>
  </section>

  <!-- ë‚ ì”¨/ì¼ì • + AI ë¹„ì„œ -->
  <section class="grid">
    <!-- í˜„ì¬ ë‚ ì”¨ -->
    <div class="card">
      <header class="card-title">í˜„ì¬ ë‚ ì”¨</header>
      <div class="row" style="margin-bottom:10px">
        <span class="pill">ì˜¨ë„: <b id="wxTemp">-</b> Â°C</span>
        <span class="pill">ìŠµë„: <b id="wxHum">-</b> %</span>
        <span class="pill">í’ì†: <b id="wxWind">-</b> m/s</span>
        <span class="pill">ê°•ìˆ˜: <b id="wxRain">-</b></span>
      </div>
      <button id="wxBtn" class="ghost">ë‚ ì”¨ ì—…ë°ì´íŠ¸</button>
      <small id="wxInfo" style="display:block;margin-top:8px;opacity:.8">ìœ„ì¹˜ í—ˆìš© í›„ ì—…ë°ì´íŠ¸ë¥¼ ëˆŒëŸ¬ì£¼ì„¸ìš”.</small>
    </div>

    <!-- AI ë¹„ì„œ (ì±„íŒ… + ìŒì„±) -->
    <div class="card">
      <header class="card-title">AI ë¹„ì„œ ì±„íŒ…</header>
      <div id="chat" class="chat">
        <div class="bot">ì•ˆë…•í•˜ì„¸ìš”, ì‹œì¥ë‹˜. ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?</div>
      </div>
      <form id="chatForm" class="chat-form" autocomplete="off">
        <button type="button" id="micBtn" title="ìŒì„±ìœ¼ë¡œ ë§í•˜ê¸°" class="ghost">ğŸ¤</button>
        <input id="msgInput" type="text" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”. (ì˜ˆ: ì˜¤ëŠ˜ ì¼ì • ìš”ì•½)" />
        <button type="submit" class="primary">ë³´ë‚´ê¸°</button>
      </form>
      <div class="tts-row">
        <label><input type="checkbox" id="ttsToggle" checked /> ì‘ë‹µì„ ìŒì„±ìœ¼ë¡œ ì½ê¸°</label>
        <div class="spacer"></div>
        <button id="ttsPause" class="ghost">â¸ï¸ ì¼ì‹œì •ì§€</button>
        <button id="ttsResume" class="ghost">â–¶ï¸ ì¬ê°œ</button>
        <button id="ttsStop" class="danger ghost">â–  ì •ì§€</button>
      </div>
      <p class="hint" style="opacity:.75;margin-top:8px">â€» íŠ¹ìˆ˜ë¬¸ì/ì´ëª¨ì§€/ë§ˆí¬ë‹¤ìš´ ë“±ì€ ì½ê¸° ì „ì— ìë™ ì •ë¦¬ë©ë‹ˆë‹¤.</p>
    </div>
  </section>

  <footer class="footer">Â© ë…¼ì‚°ì‹œ ìŠ¤ë§ˆíŠ¸ë¯¸ëŸ¬ Â· ë£¨ë¯¸ë‚˜ PRO</footer>
</main>

<!-- ì˜¤ë¥˜ ë°°ì§€ -->
<div id="errorBadge" class="error-badge">ë¬¸ì œ ê°ì§€ Â· íŒ€ì— ë³´ê³ ë¨</div>

<!-- ì „ì—­ ìœ í‹¸ -->
<script src="/ai.js"></script>

<script>
  // ===== ê³µí†µ DOM =====
  const $ = (s) => document.querySelector(s);
  const chat = $('#chat');
  const input = $('#msgInput');
  const form = $('#chatForm');
  const micBtn = $('#micBtn');
  const ttsToggle = $('#ttsToggle');
  $('#ttsPause').onclick = () => AI.ttsPause();
  $('#ttsResume').onclick = () => AI.ttsResume();
  $('#ttsStop').onclick = () => AI.ttsStop();

  // ì¸ì‚¬/ì‹œê³„
  function tick(){
    const now = new Date();
    $('#clock').textContent = now.toLocaleTimeString
('ko-KR', { hour:'2-digit', minute:'2-digit' });
    $('#today').textContent = now.toLocaleDateString
('ko-KR', { year:'numeric', month:'2-digit', day:'2-digit', weekday:'long' });
  }
  setInterval(tick, 1000); tick();

  // ì±„íŒ… ë§í’ì„ 
  function pushMsg(role, text){
    const div = document.createElement('div');
    div.className = role === 'user' ? 'user' : 'bot';
    div.textContent = text;
    chat.appendChild
(div);
    chat.scrollTop = chat.scrollHeight;
  }

  // ìŒì„± ì¸ì‹
  if (!AI.sttSupported) {
    micBtn.disabled = true;
    micBtn.title = 'ì´ ë¸Œë¼ìš°ì €ëŠ” ìŒì„± ì¸ì‹ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.';
  }
  micBtn.onclick = () => {
    AI.startRecognition((txt)=>{
      input.value = txt || '';
      form.dispatchEvent(new Event('submit', {cancelable:true}));
    }, (err)=>alert(err));
  };

  // AI í˜¸ì¶œ (functions/api ë˜ëŠ” ë°±ì—”ë“œê°€ ë™ì¼ ê²½ë¡œì¼ ë•Œ)
  async function callAI(prompt){
    // /api/ai ê°€ ì—†ëŠ” ê²½ìš°ë¥¼ ëŒ€ë¹„í•´ 2ë‹¨ê³„ í´ë°±
    try {
      const data = await AI.safeFetchJSON('/api/ai', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ prompt })
      });
      return data.text || data.reply || JSON.stringify(data);
    } catch {
      // í´ë°±: ê°„ë‹¨ ì‘ë‹µ
      return `ë©”ëª¨í•´ë‘˜ê²Œìš”: ${prompt}`;
    }
  }

  // ì „ì†¡ ì²˜ë¦¬
  form.addEventListener
('submit', async (e)=>{
    e.preventDefault();
    const q = input.value.trim();
    if (!q) return;
    input.value = '';
    pushMsg('user', q);
    try {
      const a = await callAI(q);
      pushMsg('bot', a);
      if (ttsToggle.checked) AI.speak(a);
    } catch {
      const msg = 'ì—ëŸ¬ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ê³§ ì¡°ì¹˜í•˜ê² ìŠµë‹ˆë‹¤.';
      pushMsg('bot', msg);
      if (ttsToggle.checked) AI.speak(msg);
    }
  });

  // ë‚ ì”¨
  async function updateWeather(){
    $('#wxInfo').textContent = 'ìœ„ì¹˜ í™•ì¸ ì¤‘...';
    if (!('geolocation' in navigator)) {
      $('#wxInfo').textContent = 'ì´ ê¸°ê¸°ì—ì„œ ìœ„ì¹˜ ê¶Œí•œì„ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
      return;
    }
    navigator.geolocation.getCurrentPosition(async (pos)=>{
      const { latitude:lat, longitude:lon } = pos.coords
;
      try {
        // ì—¬ëŸ¬ë¶„ì˜ ë°±ì—”ë“œ(Cloudflare Functions ë“±)ì—ì„œ ì´ ê²½ë¡œë¡œ ì‘ë‹µí•˜ë„ë¡ ì¤€ë¹„ë¨
        const data = await AI.safeFetchJSON(`/api/weather?lat=${lat}&lon=${lon}`);
        $('#wxTemp').textContent = data.temp ?? '-';
        $('#wxHum').textContent = data.humidity ?? '-';
        $('#wxWind').textContent = data.wind ?? '-';
        $('#wxRain').textContent = data.rain ?? '-';
        $('#wxInfo').textContent = data.station ? `${data.station} ê¸°ì¤€` : 'ì—…ë°ì´íŠ¸ ì™„ë£Œ';
      } catch {
        $('#wxInfo').textContent = 'ë‚ ì”¨ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.';
      }
    }, ()=>{
      $('#wxInfo').textContent = 'ìœ„ì¹˜ ê¶Œí•œì´ ê±°ë¶€ë˜ì–´ ë‚ ì”¨ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
    }, { enableHighAccuracy:false, timeout:8000 });
  }
  $('#wxBtn').onclick = updateWeather;

  // ëŸ°íƒ€ì„ ì˜¤ë¥˜ ë°°ì§€
  const showErr = ()=>{ document.getElementById('errorBadge').style.display='block'; };
  window.addEventListener
('error', showErr);
  window.addEventListener
('unhandledrejection', showErr);
</script>
<script src="/ai.js"></script>
</body>
</html>
