<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ìŠ¤ë§ˆíŠ¸ë¯¸ëŸ¬ Â· AI ë¹„ì„œ í…ŒìŠ¤íŠ¸</title>
  <style>
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,sans-serif;background:#0b0f19;color:#fff}
    .wrap{max-width:920px;margin:0 auto;padding:24px}
    h1{font-size:20px;margin:0 0 16px}
    .card{background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.15);border-radius:14px;padding:16px;margin-bottom:16px}
    .row{display:flex;gap:8px}
    input,button,textarea{border-radius:10px;border:1px solid rgba(255,255,255,.2);background:rgba(255,255,255,.06);color:#fff}
    input,textarea{flex:1;padding:12px}
    button{padding:12px 16px;cursor:pointer}
    .ok{border-color:#37d67a;background:rgba(55,214,122,.12)}
    .err{border-color:#ff6b6b;background:rgba(255,107,107,.12);white-space:pre-wrap}
    .muted{opacity:.8;font-size:14px}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;font-size:13px;white-space:pre-wrap}
    .spinner{display:none}
    .spinner.show{display:inline-block}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>AI ë¹„ì„œ ì—°ê²° ì ê²€</h1>

    <div class="card">
      <div class="muted">1) ì•„ë˜ ì…ë ¥ â†’ <b>/api/ai</b> í˜¸ì¶œ â†’ ì‘ë‹µì„ ê·¸ëŒ€ë¡œ í‘œì‹œí•©ë‹ˆë‹¤.</div>
      <div class="row" style="margin-top:10px">
        <input id="q" placeholder="ì˜ˆ) ì˜¤ëŠ˜ ì¼ì • ìš”ì•½í•´ì¤˜" />
        <button id="go">ì§ˆì˜</button>
      </div>
      <div style="margin-top:10px">
        <span id="spin" class="spinner">â³ ìš”ì²­ ì¤‘â€¦</span>
      </div>
    </div>

    <div id="outOK" class="card ok" style="display:none">
      <div><b>ì‘ë‹µ</b></div>
      <div id="okText" class="mono"></div>
    </div>

    <div id="outERR" class="card err" style="display:none">
      <div><b>ì—ëŸ¬</b> (ë„¤íŠ¸ì›Œí¬/ì„œë²„/í‚¤ ë¬¸ì œ ë“±)</div>
      <div id="errText" class="mono"></div>
    </div>

    <div class="card">
      <div class="muted">
        í™˜ê²½ë³€ìˆ˜ ì ê²€: Cloudflare Pages â†’ Settings â†’ <b>Environment variables</b> â†’<br>
        <b>GEMINI_API_KEY</b> ì¡´ì¬/ë§ì¶¤? â†’ ì €ì¥ í›„ <b>Deployments â†’ Retry deployment</b>ë¡œ ì¬ë°°í¬.
      </div>
    </div>
  </div>

  <script>
    const $ = (id)=>document.getElementById(id);
    const spin = $('spin'), outOK = $('outOK'), okText = $('okText'), outERR = $('outERR'), errText = $('errText');

    $('go').addEventListener('click', async ()=>{
      const prompt = $('q').value.trim();
      outOK.style.display='none';
      outERR.style.display='none';
      spin.classList.add('show');
      try{
        const r = await fetch('/api/ai', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ prompt })
        });

        const raw = await r.text();
        let data = null;
        try{ data = JSON.parse(raw) }catch{}

        if(!r.ok){
          outERR.style.display='block';
          errText.textContent = JSON.stringify({
            status:r.status,
            statusText:r.statusText,
            body: data ?? raw
          }, null, 2);
          return;
        }

        const text = data?.text ?? raw;
        outOK.style.display='block';
        okText.textContent = text;
      }catch(e){
        outERR.style.display='block';
        errText.textContent = 'Fetch failed: ' + String(e);
      }finally{
        spin.classList.remove('show');
      }
    });
  </script>
  <!-- ===================== AI ë¹„ì„œ ëŒ€í™” ì˜ì—­ ===================== -->
<section id="ai-assistant" style="padding:2rem; background:#0b0f19; color:#fff; min-height:100vh;">
  <h2>ì‹œì¥ë‹˜ AI ë¹„ì„œ</h2>

  <!-- ì±„íŒ… ì…ë ¥/ì¶œë ¥ -->
  <div id="chat-box" style="height:300px; overflow-y:auto; background:#111; padding:1rem; border-radius:8px; margin-bottom:1rem;"></div>

  <div style="display:flex; gap:0.5rem;">
    <input id="chat-input" type="text" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."
      style="flex:1; padding:0.5rem; border-radius:4px; border:none;">
    <button id="send-btn">ë³´ë‚´ê¸°</button>
    <button id="voice-btn">ğŸ¤ ìŒì„±</button>
  </div>
</section>

<script>
async function askGemini(prompt) {
  const res = await fetch('/api/ai', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ prompt })
  });
  const data = await res.json();
  if (!data.ok) throw new Error(data.error || 'AI error');
  return data.text;
}

// ì±„íŒ… ë°•ìŠ¤ ì—…ë°ì´íŠ¸
function appendMessage(sender, text) {
  const box = document.getElementById('chat-box');
  const msg = document.createElement('div');
  msg.innerHTML = `<b>${sender}:</b> ${text}`;
  msg.style.marginBottom = "0.5rem";
  box.appendChild(msg);
  box.scrollTop = box.scrollHeight;
}

// ë³´ë‚´ê¸° ë²„íŠ¼
document.getElementById('send-btn').addEventListener('click', async () => {
  const input = document.getElementById('chat-input');
  const text = input.value.trim();
  if (!text) return;
  appendMessage('ì‹œì¥ë‹˜', text);
  input.value = '';
  try {
    const reply = await askGemini(text);
    appendMessage('AI ë¹„ì„œ', reply);
    speak(reply);
  } catch (err) {
    appendMessage('ì‹œìŠ¤í…œ', 'âš ï¸ ì˜¤ë¥˜: ' + err.message);
  }
});

// ì—”í„°í‚¤ë„ ì „ì†¡
document.getElementById('chat-input').addEventListener('keypress', e => {
  if (e.key === 'Enter') document.getElementById('send-btn').click();
});

// ìŒì„±ì¸ì‹ (Web Speech API, í¬ë¡¬/ì—£ì§€ ì§€ì›)
let recognition;
if ('webkitSpeechRecognition' in window) {
  recognition = new webkitSpeechRecognition();
  recognition.lang = 'ko-KR';
  recognition.interimResults = false;
  recognition.maxAlternatives = 1;
  recognition.onresult = e => {
    const text = e.results[0][0].transcript;
    document.getElementById('chat-input').value = text;
    document.getElementById('send-btn').click();
  };
}

document.getElementById('voice-btn').addEventListener('click', () => {
  if (!recognition) {
    alert('ì´ ë¸Œë¼ìš°ì €ëŠ” ìŒì„±ì¸ì‹ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
    return;
  }
  recognition.start();
});

// ìŒì„± ì¶œë ¥ (TTS)
function speak(text) {
  if (!window.speechSynthesis) return;
  const utter = new SpeechSynthesisUtterance(text);
  utter.lang = 'ko-KR';
  utter.rate = 1.0;
  speechSynthesis.speak(utter);
}
</script>
<!-- =========================================================== -->
</body>
</html>
