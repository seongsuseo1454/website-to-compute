<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>스마트미러 · AI 비서 테스트</title>
  <style>
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,sans-serif;background:#0b0f19;color:#fff}
    .wrap{max-width:920px;margin:0 auto;padding:24px}
    h1{font-size:20px;margin:0 0 16px}
    .card{background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.15);border-radius:14px;padding:16px;margin-bottom:16px}
    .row{display:flex;gap:8px}
    input,button,textarea{border-radius:10px;border:1px solid rgba(255,255,255,.2);background:rgba(255,255,255,.06);color:#fff}
    input,textarea{flex:1;padding:12px}
    button{padding:12px 16px;cursor:pointer}
    .ok{border-color:#37d67a;background:rgba(55,214,122,.12)}
    .err{border-color:#ff6b6b;background:rgba(255,107,107,.12);white-space:pre-wrap}
    .muted{opacity:.8;font-size:14px}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;font-size:13px;white-space:pre-wrap}
    .spinner{display:none}
    .spinner.show{display:inline-block}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>AI 비서 연결 점검</h1>

    <div class="card">
      <div class="muted">1) 아래 입력 → <b>/api/ai</b> 호출 → 응답을 그대로 표시합니다.</div>
      <div class="row" style="margin-top:10px">
        <input id="q" placeholder="예) 오늘 일정 요약해줘" />
        <button id="go">질의</button>
      </div>
      <div style="margin-top:10px">
        <span id="spin" class="spinner">⏳ 요청 중…</span>
      </div>
    </div>

    <div id="outOK" class="card ok" style="display:none">
      <div><b>응답</b></div>
      <div id="okText" class="mono"></div>
    </div>

    <div id="outERR" class="card err" style="display:none">
      <div><b>에러</b> (네트워크/서버/키 문제 등)</div>
      <div id="errText" class="mono"></div>
    </div>

    <div class="card">
      <div class="muted">
        환경변수 점검: Cloudflare Pages → Settings → <b>Environment variables</b> →<br>
        <b>GEMINI_API_KEY</b> 존재/맞춤? → 저장 후 <b>Deployments → Retry deployment</b>로 재배포.
      </div>
    </div>
  </div>

  <script>
    const $ = (id)=>document.getElementById(id);
    const spin = $('spin'), outOK = $('outOK'), okText = $('okText'), outERR = $('outERR'), errText = $('errText');

    $('go').addEventListener('click', async ()=>{
      const prompt = $('q').value.trim();
      outOK.style.display='none';
      outERR.style.display='none';
      spin.classList.add('show');
      try{
        const r = await fetch('/api/ai', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ prompt })
        });

        const raw = await r.text();
        let data = null;
        try{ data = JSON.parse(raw) }catch{}

        if(!r.ok){
          outERR.style.display='block';
          errText.textContent = JSON.stringify({
            status:r.status,
            statusText:r.statusText,
            body: data ?? raw
          }, null, 2);
          return;
        }

        const text = data?.text ?? raw;
        outOK.style.display='block';
        okText.textContent = text;
      }catch(e){
        outERR.style.display='block';
        errText.textContent = 'Fetch failed: ' + String(e);
      }finally{
        spin.classList.remove('show');
      }
    });
  </script>
</body>
</html>
