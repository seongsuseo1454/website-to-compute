<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, viewport-fit=cover"
  />
  <title>ì‹œì¥ ì§‘ë¬´ì‹¤ ìŠ¤ë§ˆíŠ¸ ë¯¸ëŸ¬ PRO</title>
  <meta name="theme-color" content="#0b0f19" />
  <link rel="manifest" href="/manifest.webmanifest" />
  <link rel="icon" href="/icons/icon-192.png" />
  <style>
    :root {
      --bg: #0b0f19;
      --card: rgba(255,255,255,0.08);
      --border: rgba(255,255,255,0.14);
      --text: #f5f7fb;
      --muted: #a8b0c2;
      --accent: #6ee7b7;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      background: radial-gradient(1200px 1200px at 80% -10%, #1a2340 0%, #0b0f19 55%);
      color: var(--text);
      font-family: "Noto Sans KR", system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, Apple SD Gothic Neo, "ë§‘ì€ ê³ ë”•", sans-serif;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      gap: 16px;
      padding: 24px clamp(16px, 4vw, 40px);
    }
    header, main, footer {
      width: 100%;
      max-width: 1200px;
      margin: 0 auto;
    }
    .row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }
    @media (max-width: 950px) {
      .row { grid-template-columns: 1fr; }
    }
    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 16px;
      backdrop-filter: blur(8px);
      box-shadow: 0 10px 30px rgba(0,0,0,0.25);
    }
    .title { font-weight: 700; font-size: 1.2rem; margin-bottom: 6px; }
    .muted { color: var(--muted); font-size: 0.95rem; }

    /* ìƒë‹¨ ë°°ì§€/ì‹œê°„/ë‚ ì”¨ */
    .top {
      display: grid;
      grid-template-columns: 1.2fr 0.8fr;
      gap: 16px;
    }
    @media (max-width: 950px) {
      .top { grid-template-columns: 1fr; }
    }
    .clock {
      display:flex; align-items:center; justify-content:space-between;
      gap: 12px;
    }
    .time { font-size: 2.6rem; font-weight: 800; letter-spacing: 1px; }
    .date { color: var(--muted); }

    .weather {
      display: flex; gap: 12px; align-items: center; justify-content: space-between;
    }
    .weather-grid {
      display: grid; grid-template-columns: 1fr 1fr; gap: 8px;
    }
    .btn {
      appearance: none; border:1px solid var(--border); background:transparent;
      color: var(--text); padding: 8px 12px; border-radius: 10px; cursor:pointer;
    }
    .btn:hover { border-color: #7aa2ff; box-shadow: 0 0 0 3px rgba(122,162,255,0.18) inset; }

    /* ì±„íŒ… */
    .chat {
      height: 480px; display: flex; flex-direction: column; gap: 10px;
    }
    .messages {
      flex:1; overflow: auto; border:1px solid var(--border); border-radius:12px; padding:12px;
      background: rgba(0,0,0,0.15);
    }
    .msg { padding: 10px 12px; border-radius: 10px; margin-bottom: 10px; line-height: 1.5; }
    .msg.user { background: rgba(110,231,183,0.12); border: 1px solid rgba(110,231,183,0.35); }
    .msg.ai { background: rgba(122,162,255,0.12); border: 1px solid rgba(122,162,255,0.35); }
    .chat-input {
      display: grid; grid-template-columns: 1fr auto; gap: 8px;
    }
    input[type="text"], textarea {
      width: 100%; background: rgba(255,255,255,0.06);
      border: 1px solid var(--border); color: var(--text);
      padding: 10px 12px; border-radius: 10px; outline: none;
    }
    input[type="text"]:focus, textarea:focus { border-color: #7aa2ff; }
    .hint { font-size: 0.9rem; color: var(--muted); }

    /* ìŒì„± ì œì–´ */
    .voice-controls { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
    .switch { display:flex; align-items:center; gap:8px; }

    /* ìŒì„± ì¸ì‹ íŒ¨ë„ */
    .asr {
      display: grid; grid-template-rows: auto 1fr auto; gap: 10px; height: 480px;
    }
    .asr-log {
      border:1px solid var(--border); border-radius:12px; padding:12px;
      background: rgba(0,0,0,0.15); overflow:auto;
    }
    .badge { padding:2px 8px; border-radius:999px; background:rgba(110,231,183,0.14); border:1px solid rgba(110,231,183,0.35); font-size: 0.85rem;}
  </style>
</head>
<body>
  <header class="top">
    <div class="card">
      <div class="title">ì‹œì¥ë‹˜ ì•ˆë…•í•˜ì„¸ìš”</div>
      <div class="clock">
        <div>
          <div class="time" id="now-time">--:--</div>
          <div class="date" id="now-date">----.--.-- (---)</div>
        </div>
        <div class="badge">ë£¨ë¯¸ë‚˜ ìŠ¤ë§ˆíŠ¸ ë¹„ì„œ</div>
      </div>
    </div>

    <div class="card weather">
      <div>
        <div class="title">í˜„ì¬ ë‚ ì”¨</div>
        <div class="muted">ê´€ì¸¡ ì¢Œí‘œ(nx, ny) ê¸°ì¤€</div>
        <div class="weather-grid muted" style="margin-top:8px;">
          <div>ì˜¨ë„: <span id="w-temp">-</span>Â°C</div>
          <div>ìŠµë„: <span id="w-hum">-</span>%</div>
          <div>ê°•ìˆ˜: <span id="w-pty">-</span></div>
          <div>í’ì†: <span id="w-ws">-</span> m/s</div>
        </div>
      </div>
      <div>
        <button class="btn" id="btn-weather">ë‚ ì”¨ ì—…ë°ì´íŠ¸</button>
      </div>
    </div>
  </header>

  <main class="row">
    <!-- ì±„íŒ… -->
    <section class="card chat">
      <div class="title">AI ë¹„ì„œ ì±„íŒ…</div>
      <div id="messages" class="messages" aria-live="polite"></div>
      <div class="chat-input">
        <input id="chat-input" type="text" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”. (ì˜ˆ: ì˜¤ëŠ˜ ì¼ì • ìš”ì•½)" />
        <button class="btn" id="btn-send">ë³´ë‚´ê¸°</button>
      </div>
      <div class="voice-controls" style="margin-top:6px;">
        <label class="switch">
          <input type="checkbox" id="speak-toggle" checked />
          <span class="muted">ì‘ë‹µì„ ìŒì„±ìœ¼ë¡œ ì½ê¸°</span>
        </label>
        <button class="btn" onclick="pauseSpeech()">â¸ï¸ ì¼ì‹œì •ì§€</button>
        <button class="btn" onclick="resumeSpeech()">â–¶ï¸ ì¬ê°œ</button>
        <button class="btn" onclick="stopSpeech()">â¹ï¸ ì •ì§€</button>
      </div>
      <div class="hint">* íŠ¹ìˆ˜ë¬¸ì/ì´ëª¨ì§€ëŠ” ìë™ ì œê±° í›„ ë‚­ë…ë©ë‹ˆë‹¤.</div>
    </section>

    <!-- ìŒì„± ëª…ë ¹ -->
    <section class="card asr">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <div class="title">ìŒì„± ëª…ë ¹</div>
        <div id="asr-status" class="badge">ëŒ€ê¸°ì¤‘</div>
      </div>
      <div id="asr-log" class="asr-log muted">ë§ˆì´í¬ ë²„íŠ¼ì„ ëˆŒëŸ¬ ë§ì”€í•´ ì£¼ì„¸ìš”.</div>
      <div style="display:flex; gap:8px; flex-wrap:wrap;">
        <button class="btn" id="btn-mic">ğŸ¤ ìŒì„± ì¸ì‹ ì‹œì‘</button>
        <button class="btn" id="btn-mic-stop">â–  ìŒì„± ì¸ì‹ ì¤‘ì§€</button>
      </div>
      <div class="hint">* ë¸Œë¼ìš°ì €ì˜ ë§ˆì´í¬ ê¶Œí•œì„ í—ˆìš©í•´ì•¼ í•©ë‹ˆë‹¤. (Chrome ê¶Œì¥)</div>
    </section>
  </main>

  <footer class="card">
    <div class="muted">
      â“’ ë…¼ì‚°ì‹œ ì‹œì¥ ì§‘ë¬´ì‹¤ ìŠ¤ë§ˆíŠ¸ ë¯¸ëŸ¬ PRO â€” ìŒì„±/ì±„íŒ…/ë‚ ì”¨ ì—°ë™ ë°ëª¨
    </div>
  </footer>

  <!-- ai.ts(ë˜ëŠ” ai.js) ë¡œë“œ -->
  <!-- TypeScriptê°€ ê·¸ëŒ€ë¡œ ë™ì‘í•˜ì§€ ì•Šìœ¼ë©´, ë™ì¼ ë‚´ìš©ì„ /js/ai.jsë¡œ ì €ì¥í•˜ê³  ì•„ë˜ srcë¥¼ /js/ai.jsë¡œ ë°”ê¾¸ì„¸ìš”. -->
  <script src="/js/ai.ts"></script>

  <script>
    // ====== ì‹œê³„ ======
    const timeEl = document.getElementById('now-time');
    const dateEl = document.getElementById('now-date');
    const WEEK = ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '];
    function tick() {
      const d = new Date();
      const hh = String(d.getHours()).padStart(2,'0');
      const mm = String(d.getMinutes()).padStart(2,'0');
      timeEl.textContent = `${hh}:${mm}`;
      dateEl.textContent = `${d.getFullYear()}.${String(d.getMonth()+1).padStart(2,'0')}.${String(d.getDate()).padStart(2,'0')} (${WEEK[d.getDay()]})`;
    }
    tick();
    setInterval(tick, 1000 * 15);

    // ====== ì±„íŒ… UI ======
    const messagesEl = document.getElementById('messages');
    const chatInput = document.getElementById('chat-input');
    const btnSend = document.getElementById('btn-send');
    const speakToggle = document.getElementById('speak-toggle');

    function appendMsg(role, text) {
      const div = document.createElement('div');
      div.className = 'msg ' + (role === 'user' ? 'user' : 'ai');
      div.textContent = text;
      messagesEl.appendChild(div);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    btnSend.addEventListener('click', async () => {
      const prompt = chatInput.value.trim();
      if (!prompt) return;
      appendMsg('user', prompt);
      chatInput.value = '';
      appendMsg('ai', 'ìƒê° ì¤‘â€¦');

      try {
        const reply = await window.askGemini(prompt);
        messagesEl.lastElementChild.textContent = reply || 'ì‘ë‹µ ì—†ìŒ';
        if (speakToggle.checked && reply) window.speakText(reply);
      } catch (e) {
        messagesEl.lastElementChild.textContent = 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
      }
    });
    chatInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.isComposing) btnSend.click();
    });

    // ====== ë‚ ì”¨ ======
    const wTemp = document.getElementById('w-temp');
    const wHum  = document.getElementById('w-hum');
    const wPty  = document.getElementById('w-pty');
    const wWs   = document.getElementById('w-ws');
    const btnWeather = document.getElementById('btn-weather');

    function toDateTimeForKMA(d=new Date()) {
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,'0');
      const day = String(d.getDate()).padStart(2,'0');
      // ê¸°ìƒì²­ ë‹¨ê¸°ì˜ˆë³´ base_timeì€ ë³´í†µ ì •ì‹œë‹¨ìœ„(ì˜ˆ: 0600)
      const hh = String(d.getHours()).padStart(2,'0');
      const baseTime = (hh + "00");
      return { date: `${y}${m}${day}`, time: baseTime };
    }

    async function loadWeather() {
      // â˜… ë…¼ì‚°ì‹œ ì£¼ë³€ ê²©ì ì¢Œí‘œ ì˜ˆì‹œ â€” í•„ìš” ì‹œ ì‹¤ì œ nx,nyë¡œ êµì²´
      const nx = 63, ny = 98;
      const { date, time } = toDateTimeForKMA();

      const data = await window.fetchWeather(nx, ny, date, time);
      if (data?.error) {
        wTemp.textContent = '-'; wHum.textContent = '-'; wPty.textContent='-'; wWs.textContent='-';
        return;
      }
      // API ë¼ìš°í„°ì—ì„œ í‘œì¤€í™”í–ˆë‹¤ê³  ê°€ì •: { temp, humidity, ptyText, wind }
      // í˜¹ì€ ì›ë³¸ KMA ì‘ë‹µì´ë¼ë©´, ë¼ìš°í„°ì—ì„œ íŒŒì‹±í•´ì£¼ê³  ì˜¤ì„¸ìš”.
      try {
        wTemp.textContent = data.temp ?? '-';
        wHum.textContent  = data.humidity ?? '-';
        wPty.textContent  = data.ptyText ?? '-';
        wWs.textContent   = data.wind ?? '-';
      } catch {
        wTemp.textContent = '-'; wHum.textContent = '-'; wPty.textContent='-'; wWs.textContent='-';
      }
    }
    btnWeather.addEventListener('click', loadWeather);
    loadWeather();

    // ====== ìŒì„± ì¸ì‹ (Web Speech API) ======
    const asrStatus = document.getElementById('asr-status');
    const asrLog = document.getElementById('asr-log');
    const btnMic = document.getElementById('btn-mic');
    const btnMicStop = document.getElementById('btn-mic-stop');

    const SpeechRec = window.SpeechRecognition || window.webkitSpeechRecognition;
    let rec = null;

    function setASR(on) {
      asrStatus.textContent = on ? 'ë“£ëŠ” ì¤‘' : 'ëŒ€ê¸°ì¤‘';
      asrStatus.style.background = on ? 'rgba(122,162,255,0.18)' : 'rgba(110,231,183,0.14)';
      asrStatus.style.border = on ? '1px solid rgba(122,162,255,0.45)' : '1px solid rgba(110,231,183,0.35)';
    }

    if (SpeechRec) {
      rec = new SpeechRec();
      rec.lang = 'ko-KR';
      rec.interimResults = true;
      rec.continuous = true;

      rec.onstart = () => { setASR(true); };
      rec.onend = () => { setASR(false); };
      rec.onerror = (e) => {
        setASR(false);
        asrLog.textContent = 'ìŒì„± ì¸ì‹ ì˜¤ë¥˜: ' + (e.error || 'unknown');
      };
      rec.onresult = async (e) => {
        let finalText = '';
        for (let i = e.resultIndex; i < e.results.length; i++) {
          const t = e.results[i][0].transcript;
          if (e.results[i].isFinal) finalText += t;
        }
        if (finalText) {
          // ì±„íŒ…ì²˜ëŸ¼ ì²˜ë¦¬: í™”ë©´ì— ì¶”ê°€ + AI í˜¸ì¶œ + ë‚­ë…
          appendMsg('user', finalText);
          appendMsg('ai', 'ìƒê° ì¤‘â€¦');
          try {
            const reply = await window.askGemini(finalText);
            messagesEl.lastElementChild.textContent = reply || 'ì‘ë‹µ ì—†ìŒ';
            if (speakToggle.checked && reply) window.speakText(reply);
          } catch (e) {
            messagesEl.lastElementChild.textContent = 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
          }
          asrLog.textContent = 'ë§ˆì§€ë§‰ ì¸ì‹: ' + finalText;
        }
      };

      btnMic.addEventListener('click', () => {
        try { rec.start(); } catch {}
      });
      btnMicStop.addEventListener('click', () => {
        try { rec.stop(); } catch {}
      });
    } else {
      asrLog.textContent = 'ì´ ë¸Œë¼ìš°ì €ëŠ” ìŒì„± ì¸ì‹ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. (Chrome ì‚¬ìš© ê¶Œì¥)';
      btnMic.disabled = true;
      btnMicStop.disabled = true;
    }

    // ìŒì„± ì œì–´ ë²„íŠ¼ì´ index.htmlì—ì„œ window.* í˜¸ì¶œ
    window.pauseSpeech = window.pauseSpeech;
    window.resumeSpeech = window.resumeSpeech;
    window.stopSpeech   = window.stopSpeech;
  </script>
</body>
</html>
