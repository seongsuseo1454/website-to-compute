<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>시장 집무실 스마트 미러 PRO</title>

  <!-- PWA -->
  <link rel="manifest" href="./manifest.webmanifest" />
  <link rel="icon" type="image/png" sizes="192x192" href="./icon-192.png" />
  <link rel="icon" type="image/png" sizes="512x512" href="./icon-512.png" />
  <meta name="theme-color" content="#0b0f19" />

  <!-- CSS -->
  <link rel="stylesheet" href="./style.css" />
</head>
<body>
  <header>
    <h1>시장 집무실 스마트 미러 PRO</h1>
    <time id="clock"></time>
  </header>

  <main>
    <!-- 오늘 일정 -->
    <section id="schedule">
      <h2>오늘 일정</h2>
      <div id="schedule-content">불러오는 중...</div>
    </section>

    <!-- 지역/날씨 -->
    <section id="weather">
      <h2>지역/날씨</h2>
      <div id="weather-content">날씨 정보를 불러오는 중...</div>
    </section>

    <!-- 건강 상태 -->
    <section id="health">
      <h2>건강 (데모)</h2>
      <ul>
        <li>심박수: <span id="heart-rate">--</span></li>
        <li>혈압: <span id="blood-pressure">--</span></li>
        <li>걸음수: <span id="steps">--</span></li>
        <li>수분: <span id="hydration">--</span></li>
      </ul>
    </section>

    <!-- AI 비서 -->
    <section id="ai-assistant">
      <h2>AI 비서</h2>
      <div id="chat-box">
        <div id="chat-log"></div>
        <input id="chat-input" type="text" placeholder="메모/날씨/긴급 지시 입력..." />
        <button id="chat-send">보내기</button>
      </div>
    </section>
  </main>

  <!-- JS -->
  <script type="module" src="./ai.ts"></script>
  <script>
    // 시계
    function updateClock() {
      const now = new Date();
      document.getElementById("clock").textContent =
        now.toLocaleTimeString("ko-KR") + " " +
        now.toLocaleDateString("ko-KR");
    }
    setInterval(updateClock, 1000);
    updateClock();

    // AI 비서 이벤트
    const chatInput = document.getElementById("chat-input");
    const chatSend = document.getElementById("chat-send");
    const chatLog = document.getElementById("chat-log");

    async function sendMessage() {
      const text = chatInput.value.trim();
      if (!text) return;
      chatLog.innerHTML += `<div><b>나:</b> ${text}</div>`;
      chatInput.value = "";

      try {
        const res = await fetch("/api/ai", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ prompt: text })
        });
        const data = await res.json();
        chatLog.innerHTML += `<div><b>AI:</b> ${data.text}</div>`;
      } catch (err) {
        chatLog.innerHTML += `<div style="color:red"><b>에러:</b> AI 응답 실패</div>`;
      }
    }

    chatSend.addEventListener("click", sendMessage);
    chatInput.addEventListener("keydown", e => {
      if (e.key === "Enter") sendMessage();
    });

    // 날씨 API (테스트 버튼)
    async function fetchWeather(nx=60, ny=127, date="20250918", time="0600") {
      try {
        const res = await fetch(`/api/weather?nx=${nx}&ny=${ny}&date=${date}&time=${time}&type=JSON`);
        const data = await res.json();
        document.getElementById("weather-content").textContent =
          JSON.stringify(data, null, 2);
      } catch {
        document.getElementById("weather-content").textContent = "날씨 불러오기 실패";
      }
    }
    fetchWeather();
  </script>
</body>
</html>
