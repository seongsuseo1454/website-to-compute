<!-- index.html â€” FINAL (ìŠ¤ë§ˆíŠ¸ë¯¸ëŸ¬ + ì±„íŒ… + ë‚ ì”¨ + ì‹¤ì‹œê°„ í†µì—­) -->
<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ì‹œì¥ë‹˜ ì§‘ë¬´ì‹¤ Â· ìŠ¤ë§ˆíŠ¸ ë¯¸ëŸ¬ PRO</title>

  <!-- PWA -->
  <link rel="manifest" href="/manifest.webmanifest" />
  <link rel="icon" sizes="192x192" href="/icon-192.png" />
  <link rel="icon" sizes="512x512" href="/icon-512.png" />
  <meta name="theme-color" content="#0b0f19" />
  <link rel="stylesheet" href="/style.css" />
</head>
<body>
<main class="container">
  <!-- ìƒë‹¨ ì¸ì‚¬/ì‹œê³„ -->
  <section class="hero">
    <div>
      <h1 id="greet">í™œê¸°ì°¬ í•˜ë£¨ì…ë‹ˆë‹¤, ì‹œì¥ë‹˜</h1>
      <p class="sub" id="today"></p>
    </div>
    <div class="clock" id="clock">--:--</div>
  </section>

  <!-- ë¹ ë¥¸ ì—…ë¬´ íŠ¸ë¦¬ê±° (id=trstart ìœ ì§€) -->
  <section id="trstart" class="card">
    <div class="title">ì—…ë¬´ íŠ¸ë¦¬ê±° & ë¹ ë¥¸ ì „í™˜</div>
    <div class="desc">ìì£¼ ì“°ëŠ” ëª…ë ¹ì„ í„°ì¹˜ë¡œ ì‹¤í–‰í•˜ì„¸ìš”.</div>
    <div class="row">
      <button class="btn" onclick="
        document.getElementById('msgInput').value='ë‚´ì¼ 10ì‹œ ë³µì§€ê³¼ íšŒì˜ ì¶”ê°€';
        document.getElementById('chatForm').dispatchEvent(new Event('submit',{cancelable:true}))">
        ë‚´ì¼ 10ì‹œ íšŒì˜ ì¶”ê°€
      </button>
      <button class="btn" onclick="location.href='/admin.html'">ê´€ë¦¬ì ì…ë ¥ì°½</button>
    </div>
  </section>

  <!-- ì˜¤ëŠ˜ì˜ ë‚ ì”¨ -->
  <section class="card">
    <header class="card-title">ì˜¤ëŠ˜ì˜ ë‚ ì”¨</header>
    <div id="weatherBox" class="weather">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
  </section>

  <!-- AI ë¹„ì„œ (ì±„íŒ… + ìŒì„±) -->
  <section class="card">
    <header class="card-title">AI ë¹„ì„œ (ì±„íŒ… + ìŒì„±)</header>
    <div id="chat" class="chat">
      <div class="bot">ì•ˆë…•í•˜ì„¸ìš”, ì‹œì¥ë‹˜. ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?</div>
    </div>

    <form id="chatForm" class="chat-form">
      <button type="button" id="micBtn" title="ìŒì„±ìœ¼ë¡œ ë§í•˜ê¸°" class="ghost big-mic">ğŸ¤</button>
      <input id="msgInput" type="text" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”. (ì˜ˆ: ì˜¤ëŠ˜ ì¼ì • ìš”ì•½)" autocomplete="off" />
      <button type="submit" class="primary">ë³´ë‚´ê¸°</button>
    </form>

    <div class="tts-row">
      <label><input type="checkbox" id="ttsToggle" checked /> ì‘ë‹µì„ ìŒì„±ìœ¼ë¡œ ì½ê¸°</label>
      <div class="spacer"></div>
      <button id="ttsPause" class="ghost">â¸ï¸ ì¼ì‹œì •ì§€</button>
      <button id="ttsResume" class="ghost">â–¶ï¸ ì¬ê°œ</button>
      <button id="ttsStop" class="danger ghost">â–  ì •ì§€</button>
    </div>
    <p class="hint">â€» íŠ¹ìˆ˜ë¬¸ì/ì´ëª¨ì§€/ë§ˆí¬ë‹¤ìš´ ë“±ì€ ì½ê¸° ì „ì— ìë™ ì •ë¦¬ë©ë‹ˆë‹¤.</p>
  </section>

  <!-- ì˜¤ëŠ˜ ì¼ì • -->
  <section class="card">
    <header class="card-title">ì˜¤ëŠ˜ ì¼ì •</header>
    <ul id="schedList" class="sched"></ul>
  </section>

  <!-- ì‹œì • ë‰´ìŠ¤ / ë¶€ì„œë³„ ë³´ê³  -->
  <section class="grid">
    <div class="card">
      <header class="card-title">ì‹œì • ë‰´ìŠ¤</header>
      <ul id="newsList" class="feed"></ul>
    </div>
    <div class="card">
      <header class="card-title">ë¶€ì„œë³„ ì—…ë¬´ë³´ê³ </header>
      <ul id="deptList" class="feed"></ul>
    </div>
  </section>

  <!-- ì‹¤ì‹œê°„ í†µì—­ (14ê°œ ì–¸ì–´) -->
  <section class="card">
    <header class="card-title">ì‹¤ì‹œê°„ í†µì—­ (14ê°œ ì–¸ì–´)</header>

    <div class="row" style="gap:12px;align-items:center;flex-wrap:wrap">
      <label>ì…ë ¥(ë§í•˜ê¸°)
        <select id="trSrc">
          <option value="ko">í•œêµ­ì–´</option><option value="en">English</option>
          <option value="ja">æ—¥æœ¬èª</option><option value="zh">ä¸­æ–‡</option>
          <option value="fr">FranÃ§ais</option><option value="de">Deutsch</option>
          <option value="es">EspaÃ±ol</option><option value="pt">PortuguÃªs</option>
          <option value="ru">Ğ ÑƒÑÑĞºĞ¸Ğ¹</option><option value="vi">Tiáº¿ng Viá»‡t</option>
          <option value="th">à¹„à¸—à¸¢</option><option value="id">Bahasa Indonesia</option>
          <option value="ar">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option><option value="hi">à¤¹à¤¿à¤¨à¥à¤¦à¥€</option>
        </select>
      </label>

      <label>ì¶œë ¥(ì½ì–´ì£¼ê¸°)
        <select id="trDst">
          <option value="en">English</option><option value="ko">í•œêµ­ì–´</option>
          <option value="ja">æ—¥æœ¬èª</option><option value="zh">ä¸­æ–‡</option>
          <option value="fr">FranÃ§ais</option><option value="de">Deutsch</option>
          <option value="es">EspaÃ±ol</option><option value="pt">PortuguÃªs</option>
          <option value="ru">Ğ ÑƒÑÑĞºĞ¸Ğ¹</option><option value="vi">Tiáº¿ng Viá»‡t</option>
          <option value="th">à¹„à¸—à¸¢</option><option value="id">Bahasa Indonesia</option>
          <option value="ar">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option><option value="hi">à¤¹à¤¿à¤¨à¥à¤¦à¥€</option>
        </select>
      </label>

      <button id="trStart" class="btn-xl primary" title="ë§í•˜ê¸° ì‹œì‘">ğŸ¤ í¬ê²Œ ë§í•˜ê¸°</button>
      <button id="trStop"  class="ghost danger" disabled>â–  í†µì—­ ì •ì§€</button>
    </div>

    <div class="row" style="gap:12px;margin-top:12px">
      <textarea id="trIn"  class="mono" placeholder="ì…ë ¥ ì¸ì‹ í…ìŠ¤íŠ¸â€¦" rows="2" style="flex:1"></textarea>
      <textarea id="trOut" class="mono" placeholder="ë²ˆì—­ ê²°ê³¼â€¦" rows="2" style="flex:1"></textarea>
    </div>

    <div class="row" style="gap:8px;margin-top:8px">
      <button id="trTranslate" class="ghost">í…ìŠ¤íŠ¸ ë²ˆì—­</button>
      <button id="trSpeak" class="ghost">â–¶ï¸ ë²ˆì—­ ì½ì–´ì£¼ê¸°</button>
    </div>
  </section>

  <footer class="footer">Â© ë…¼ì‚°ì‹œ ìŠ¤ë§ˆíŠ¸ë¯¸ëŸ¬ Â· ë£¨ë¯¸ë‚˜ PRO</footer>
</main>

<!-- ì—ëŸ¬ ë°°ì§€ -->
<style>.error-badge{position:fixed;right:12px;bottom:12px;background:#ff4d4f;color:#fff;padding:8px 10px;border-radius:8px;font-size:12px;display:none;z-index:9999}</style>
<div id="errorBadge" class="error-badge">ë¬¸ì œ ê°ì§€ Â· íŒ€ì— ë³´ê³ ë¨</div>

<!-- ê³µìš© ìœ í‹¸(/root/ai.js) â€“ sanitizeForTTS, askAI ë“± -->
<script src="/ai.js"></script>

<script>
/* ===== ê³µí†µ(ì‹œê³„/ì¸ì‚¬/ì±„íŒ… TTSÂ·STT/ë‚ ì”¨/ëª©ë¡ ë¡œë“œ/ì—ëŸ¬í‘œì‹œ) ===== */
const $=(s)=>document.querySelector(s);
const chat=$('#chat'), input=$('#msgInput'), form=$('#chatForm');
const micBtn=$('#micBtn'), ttsToggle=$('#ttsToggle');
const ttsPause=$('#ttsPause'), ttsResume=$('#ttsResume'), ttsStop=$('#ttsStop');

function tick(){
  const now=new Date();
  $('#clock').textContent=now.toLocaleTimeString('ko-KR',{hour:'2-digit',minute:'2-digit'});
  $('#today').textContent=now.toLocaleDateString('ko-KR',{year:'numeric',month:'2-digit',day:'2-digit',weekday:'long'});
  $('#greet').textContent=(now.getHours()<12?'ì¢‹ì€ ì•„ì¹¨ì…ë‹ˆë‹¤':'í™œê¸°ì°¬ í•˜ë£¨ì…ë‹ˆë‹¤')+', ì‹œì¥ë‹˜';
}
setInterval(tick,1000); tick();

function pushMsg(role,text){
  const div=document.createElement('div');
  div.className=role==='user'?'user':'bot';
  div.textContent=text; chat.appendChild(div); chat.scrollTop=chat.scrollHeight;
}

function speak(text){
  if(!ttsToggle.checked) return;
  const line=window.sanitizeForTTS?window.sanitizeForTTS(text):text;
  if(!line) return;
  speechSynthesis.cancel();
  const u=new SpeechSynthesisUtterance(line); u.lang='ko-KR'; u.rate=1.0; u.pitch=1.0;
  speechSynthesis.speak(u);
}
ttsPause.onclick=()=>speechSynthesis.pause();
ttsResume.onclick=()=>speechSynthesis.resume();
ttsStop.onclick=()=>speechSynthesis.cancel();

let rec;
if('webkitSpeechRecognition'in window){
  const R=window.webkitSpeechRecognition; rec=new R();
  rec.lang='ko-KR'; rec.continuous=false; rec.interimResults=false;
  rec.onresult=(e)=>{ const txt=e.results?.[0]?.[0]?.transcript||''; input.value=txt;
    form.dispatchEvent(new Event('submit',{cancelable:true})); };
}else{ micBtn.disabled=true; micBtn.title='ì´ ë¸Œë¼ìš°ì €ëŠ” ìŒì„± ì¸ì‹ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.'; }
micBtn.onclick=()=>{ try{ rec&&rec.start(); }catch(_){} };

async function callAI(prompt){
  if(typeof window.askAI==='function') return await window.askAI(prompt);
  const res=await fetch('/api/ai',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({prompt})});
  if(!res.ok) throw new Error('AI ì‘ë‹µ ì‹¤íŒ¨'); const data=await res.json(); return data.text||data.reply||JSON.stringify(data);
}
form.addEventListener('submit', async (e)=>{
  e.preventDefault(); const q=input.value.trim(); if(!q) return;
  input.value=''; pushMsg('user',q);
  try{ const a=await callAI(q); pushMsg('bot',a); speak(a); }
  catch(err){ const m='ì—ëŸ¬ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ê³§ ì¡°ì¹˜í•˜ê² ìŠµë‹ˆë‹¤.'; pushMsg('bot',m); speak(m);
    fetch('/api/report',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({type:'AI_FAIL',detail:String(err)})}).catch(()=>{}); }
});

async function loadWeather(){
  try{
    const nx=60, ny=127;
    const r=await fetch(`/api/weather?nx=${nx}&ny=${ny}`); const j=await r.json();
    $('#weatherBox').textContent=j?.summary||'ë‚ ì”¨ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
  }catch{ $('#weatherBox').textContent='ë‚ ì”¨ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'; }
}
loadWeather();

async function loadKV(listId,key){
  try{ const r=await fetch(`/api/admin?list=${encodeURIComponent(key)}`); if(!r.ok) throw 0;
    const items=await r.json(); renderList(listId,items);
  }catch{ renderList(listId,[]); }
}
function renderList(id,items){
  const el=$(id); el.innerHTML='';
  if(!items?.length){ const li=document.createElement('li'); li.className='empty'; li.textContent='ë“±ë¡ëœ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.'; el.appendChild(li); return; }
  for(const it of items){
    const li=document.createElement('li');
    li.innerHTML=`<div class="feed-title">${it.title||it.text}</div><div class="feed-sub">${it.time||it.source||''} ${it.location||''}</div>`;
    el.appendChild(li);
  }
}
loadKV('#schedList','SCHEDULE:TODAY'); loadKV('#newsList','NEWS'); loadKV('#deptList','DEPT');

window.addEventListener('error',()=>{$('#errorBadge').style.display='block';});
window.addEventListener('unhandledrejection',()=>{$('#errorBadge').style.display='block';});
</script>

<!-- ===== ì‹¤ì‹œê°„ í†µì—­ (ì…ë ¥ ì´ˆê¸°í™” + ìë™ë²ˆì—­ + ìë™ì½ê¸°) ===== -->
<script>
const trSrc = document.querySelector('#trSrc');
const trDst = document.querySelector('#trDst');
const trIn  = document.querySelector('#trIn');
const trOut = document.querySelector('#trOut');
const trStart = document.querySelector('#trStart');
const trStop  = document.querySelector('#trStop');
const btnTextTranslate = document.querySelector('#trTranslate');
const btnSpeak = document.querySelector('#trSpeak');

// ì–¸ì–´ì½”ë“œ â†’ ë¸Œë¼ìš°ì € TTSìš© locale
function mapLocale(lang){
  return ({ko:'ko-KR',en:'en-US',ja:'ja-JP',zh:'zh-CN',fr:'fr-FR',de:'de-DE',es:'es-ES',
           pt:'pt-PT',ru:'ru-RU',vi:'vi-VN',th:'th-TH',id:'id-ID',ar:'ar-SA',hi:'hi-IN'})[lang]||'en-US';
}

// ë²ˆì—­ API í˜¸ì¶œ
async function doTranslateText(){
  const src=trSrc.value, dst=trDst.value, text=(trIn.value||'').trim();
  if(!text) return;
  trStart.disabled=true; trOut.value='ë²ˆì—­ ì¤‘â€¦';
  try{
    const r=await fetch('/api/translate',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({src,dst,text})});
    const j=await r.json().catch(()=>({}));
    const out=j.text||j.translation||j.translated||'ê²°ê³¼ ì—†ìŒ';
    trOut.value=out; trIn.value='';                         // ì…ë ¥ ë¹„ì›€(ëˆ„ì  ë°©ì§€)
    speakTranslate(out,dst);                                // ìë™ ì½ê¸°
  }catch{ trOut.value='ë²ˆì—­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'; }
  finally{ trStart.disabled=false; }
}

// ë²ˆì—­ë¬¸ ì½ê¸°
function speakTranslate(text,dstLang){
  if(!text) return;
  const cleaned=(window.sanitizeForTTS?window.sanitizeForTTS(text):text);
  try{ speechSynthesis.cancel(); const u=new SpeechSynthesisUtterance(cleaned);
       u.lang=mapLocale(dstLang); u.rate=1.0; u.pitch=1.0; speechSynthesis.speak(u);}catch{}
}
btnTextTranslate.onclick=doTranslateText;
btnSpeak.onclick=()=>speakTranslate(trOut.value,trDst.value);

// STT(í†µì—­ìš©) â€” ìë™ ë²ˆì—­/ì½ê¸° + ì‹œì‘ ì‹œ ì´ˆê¸°í™”
let trRec=null;
if('webkitSpeechRecognition'in window){
  const R=window.webkitSpeechRecognition; trRec=new R();
  trRec.continuous=true; trRec.interimResults=false; trRec.lang=mapLocale(trSrc.value);
  trRec.onstart=()=>{ trStart.disabled=true; trStop.disabled=false; trIn.value=''; trOut.value=''; };
  trRec.onend  =()=>{ trStart.disabled=false; trStop.disabled=true; };
  trRec.onerror=()=>{ trOut.value='ìŒì„± ì¸ì‹ ì˜¤ë¥˜'; };
  trRec.onresult=(e)=>{
    let finalText=''; for(let i=e.resultIndex;i<e.results.length;i++){ if(e.results[i].isFinal) finalText+=e.results[i][0].transcript+' '; }
    finalText=finalText.trim(); if(finalText){ trIn.value=finalText; doTranslateText(); } // ìë™ ë²ˆì—­+ì½ê¸°
  };
}else{ trStart.disabled=true; trStart.title='ë¸Œë¼ìš°ì €ê°€ ìŒì„±ì¸ì‹ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.'; }

trStart.onclick=()=>{ if(!trRec){return;} trRec.lang=mapLocale(trSrc.value); try{ trRec.start(); }catch{} };
trStop.onclick =()=>{ try{ trRec&&trRec.stop(); }catch{} speechSynthesis.cancel(); };

trSrc.addEventListener('change',()=>{ if(trRec) trRec.lang=mapLocale(trSrc.value); });
</script>
</body>
</html>
