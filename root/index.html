<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ì‹œì¥ë‹˜ ì§‘ë¬´ì‹¤ Â· ìŠ¤ë§ˆíŠ¸ ë¯¸ëŸ¬ PRO</title>

  <!-- PWA -->
  <link rel="manifest" href="/manifest.webmanifest" />
  <link rel="icon" sizes="192x192" href="/icon-192.png" />
  <link rel="icon" sizes="512x512" href="/icon-512.png" />
  <meta name="theme-color" content="#0b0f19" />

  <link rel="stylesheet" href="/style.css" />
</head>
<body>
  <main class="container">
    <!-- ìƒë‹¨ ì¸ì‚¬/ì‹œê³„ -->
    <section class="hero">
      <div>
        <h1 id="greet">í™œê¸°ì°¬ í•˜ë£¨ì…ë‹ˆë‹¤, ì‹œì¥ë‹˜</h1>
        <p class="sub" id="today"></p>
      </div>
      <div class="clock" id="clock">--:--</div>
    </section>

    <!-- AI ë¹„ì„œ (ì±„íŒ… + ìŒì„±) -->
    <section class="card">
      <header class="card-title">AI ë¹„ì„œ (ì±„íŒ… + ìŒì„±)</header>

      <div id="chat" class="chat">
        <div class="bot">ì•ˆë…•í•˜ì„¸ìš”, ì‹œì¥ë‹˜. ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?</div>
      </div>

      <form id="chatForm" class="chat-form">
        <button type="button" id="micBtn" title="ìŒì„±ìœ¼ë¡œ ë§í•˜ê¸°" class="ghost">ğŸ¤</button>
        <input id="msgInput" type="text" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”. (ì˜ˆ: ì˜¤ëŠ˜ ì¼ì • ìš”ì•½)" autocomplete="off" />
        <button type="submit" class="primary">ë³´ë‚´ê¸°</button>
      </form>

      <div class="tts-row">
        <label><input type="checkbox" id="ttsToggle" checked /> ì‘ë‹µì„ ìŒì„±ìœ¼ë¡œ ì½ê¸°</label>
        <div class="spacer"></div>
        <button id="ttsPause" class="ghost">â¸ï¸ ì¼ì‹œì •ì§€</button>
        <button id="ttsResume" class="ghost">â–¶ï¸ ì¬ê°œ</button>
        <button id="ttsStop" class="danger ghost">â–  ì •ì§€</button>
      </div>

      <p class="hint">â€» íŠ¹ìˆ˜ë¬¸ì/ì´ëª¨ì§€/ë§ˆí¬ë‹¤ìš´ ë“±ì€ ì½ê¸° ì „ì— ìë™ ì •ë¦¬ë©ë‹ˆë‹¤.</p>
    </section>

    <!-- ë°”ë‹¥ í‘œì‹œ -->
    <footer class="footer">Â© ë…¼ì‚°ì‹œ ìŠ¤ë§ˆíŠ¸ë¯¸ëŸ¬ Â· ë£¨ë¯¸ë‚˜ PRO</footer>
  </main>

  <!-- ë¹„ì„œ ë¡œì§(ì„ í–‰ ì œê³µëœ /ai.js ì‚¬ìš©). ì—†ìœ¼ë©´ ì•ˆì „í•œ í´ë°± fetch ì‚¬ìš© -->
  <script src="/ai.js"></script>
  
  <style>
  .error-badge{position:fixed;right:12px;bottom:12px;background:#ff4d4f;color:#fff;padding:8px 10px;border-radius:8px;font-size:12px;display:none;z-index:9999}
</style>
<div id="errorBadge" class="error-badge">ë¬¸ì œ ê°ì§€ Â· íŒ€ì— ë³´ê³ ë¨</div>
<script>
  window.addEventListener('error', ()=>{ document.getElementById('errorBadge').style.display='block'; });
  window.addEventListener('unhandledrejection', ()=>{ document.getElementById('errorBadge').style.display='block'; });
  <script>
    // ===== ê³µí†µ ìœ í‹¸ =====
    const $ = (sel) => document.querySelector(sel);
    const chat = $('#chat');
    const input = $('#msgInput');
    const form = $('#chatForm');
    const micBtn = $('#micBtn');
    const ttsToggle = $('#ttsToggle');
    const ttsPause = $('#ttsPause');
    const ttsResume = $('#ttsResume');
    const ttsStop = $('#ttsStop');

    // íŠ¹ìˆ˜ë¬¸ì/ì´ëª¨ì§€/ë§ˆí¬ë‹¤ìš´ ì œê±°(ìŒì„±ìš©)
    function sanitizeForTTS(text) {
      return (text ?? '')
        .replace(/[#*_`>~|[\](){}+-]+/g, ' ')
        .replace(/https?:\/\/\S+/g, ' ')
        .replace(/[:;=8xX]-?[\)D\(PpOo\/\\]|ğŸ§¡|â¤ï¸|[\u{1F300}-\u{1FAFF}]/gu, ' ')
        .replace(/\s+/g, ' ')
        .trim();
    }

    // ì±„íŒ… ë§í’ì„  ì¶”ê°€
    function pushMsg(role, text) {
      const div = document.createElement('div');
      div.className = role === 'user' ? 'user' : 'bot';
      div.textContent = text;
      chat.appendChild
(div);
      chat.scrollTop = chat.scrollHeight;
    }

    // ì‹œê³„/ë‚ ì§œ
    function tick() {
      const now = new Date();
      $('#clock').textContent =
        now.toLocaleTimeString
('ko-KR', { hour: '2-digit', minute: '2-digit' });
      $('#today').textContent =
        now.toLocaleDateString
('ko-KR', { year: 'numeric', month: '2-digit', day: '2-digit', weekday: 'long' });
    }
    setInterval(tick, 1000); tick();

    // ===== ìŒì„± í•©ì„±(TTS) =====
    function speak(text) {
      if (!ttsToggle.checked) return;
      const line = sanitizeForTTS(text);
      if (!line) return;
      window.speechSynthesis.cancel
();
      const u = new SpeechSynthesisUtterance(line);
      u.lang = 'ko-KR';
      u.rate = 1.0;
      u.pitch = 1.0;
      window.speechSynthesis.speak(u);
    }
    ttsPause.onclick = () => window.speechSynthesis.pause();
    ttsResume.onclick = () => window.speechSynthesis.resume();
    ttsStop.onclick = () => window.speechSynthesis.cancel
();

    // ===== ìŒì„± ì¸ì‹(STT) =====
    let rec;
    if ('webkitSpeechRecognition' in window) {
      const R = window.webkitSpeechRecognition;
      rec = new R();
      rec.lang = 'ko-KR';
      rec.continuous
 = false;
      rec.interimResults
 = false;
      rec.onresult = (e) => {
        const txt = e.results[0][0].transcript;
        input.value = txt;
        form.dispatchEvent(new Event('submit', { cancelable: true }));
      };
      rec.onerror = () => alert('ìŒì„± ì¸ì‹ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.');
    } else {
      micBtn.disabled = true;
      micBtn.title = 'ì´ ë¸Œë¼ìš°ì €ëŠ” ìŒì„± ì¸ì‹ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.';
    }
    micBtn.onclick = () => { try { rec && rec.start(); } catch(_) {} };

    // ===== AI í˜¸ì¶œ: ai.js ìˆìœ¼ë©´ ì‚¬ìš©, ì—†ìœ¼ë©´ /api/ai í´ë°± =====
    async function callAI(prompt) {
      if (typeof window.askAI === 'function') {
        return await window.askAI(prompt);   // ai.jsì—ì„œ ì •ì˜í•œ í•¨ìˆ˜ ì‚¬ìš©
      }
      // í´ë°±(fetch)
      const res = await fetch('/api/ai', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ prompt })
      });
      if (!res.ok) throw new Error('AI ì‘ë‹µ ì‹¤íŒ¨');
      const data = await res.json();
      return data.text || data.reply || JSON.stringify(data);
    }

    // ===== ì „ì†¡ ì²˜ë¦¬ =====
    form.addEventListener
('submit', async (e) => {
      e.preventDefault();
      const q = input.value.trim();
      if (!q) return;
      input.value = '';
      pushMsg('user', q);

      try {
        const a = await callAI(q);
        pushMsg('bot', a);
        speak(a);
      } catch (err) {
        const msg = 'ì—ëŸ¬ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ê³§ ì¡°ì¹˜í•˜ê² ìŠµë‹ˆë‹¤.';
        pushMsg('bot', msg);
        speak(msg);
        // ì—¬ê¸°ì— ì›ê²© ì•Œë¦¼ í›…ì„ ì—°ê²°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤ (ì˜ˆ: /api/alert)
        // fetch('/api/alert', { method:'POST', body: JSON.stringify({ type:'AI_FAIL', detail: String(err) }) })
      }
    });
  </script>
  <script>
/* ===== AIDEV-NOTE: ë¸Œë¼ìš°ì € ì—ëŸ¬/ê±°ë¶€/ë„¤íŠ¸ì›Œí¬ ì‹¤íŒ¨ ìë™ ë¦¬í¬íŠ¸ ===== */

(function () {
  const REPORT_URL = '/api/report';
  const REPORT_SAMPLE_RATE = 1.0; // 0~1.0, ê³¼ë„í•œ ì „ì†¡ ë°©ì§€ìš©
  const REPORT_COOLDOWN_MS = 10_000; // ë™ì¼ ì—ëŸ¬ ê³¼ë„ ì „ì†¡ ë°©ì§€(10ì´ˆ)
  const STORAGE_KEY = 'last_error_sig';

  function hash(s) { // ê°„ë‹¨í•œ ì‹œê·¸ë‹ˆì²˜
    let h = 0;
    for (let i = 0; i < s.length; i++) h = (h * 31 + s.charCodeAt(i)) | 0;
    return String(h);
  }

  function shouldSample() {
    return Math.random() <= REPORT_SAMPLE_RATE;
  }

  function dedupe(signature) {
    try {
      const item = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
      const now = Date.now();
      if (item.sig === signature && now - item.ts < REPORT_COOLDOWN_MS) return false;
      localStorage.setItem(STORAGE_KEY, JSON.stringify({ sig: signature, ts: now }));
      return true;
    } catch { return true; }
  }

  async function reportError(payload) {
    try {
      if (!shouldSample()) return;
      const sig = hash([payload.type, payload.message
, payload.stack].filter(Boolean).join('|'));
      if (!dedupe(sig)) return;

      await fetch(REPORT_URL, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
          ...payload,
          sig,
          url: location.href,
          ua: navigator.userAgent
,
          at: new Date().toISOString(),
          // ê°œì¸ì •ë³´/í† í°ì´ í¬í•¨ë  ìˆ˜ ìˆëŠ” ë¡œì»¬ìŠ¤í† ë¦¬ì§€/ì¿ í‚¤/í¼ ë‚´ìš©ì€ ì ˆëŒ€ ì „ì†¡í•˜ì§€ ì•ŠìŒ
        }),
        keepalive: true,
      });
    } catch { /* ë¦¬í¬íŠ¸ ì‹¤íŒ¨ëŠ” ë¬´ì‹œ */ }
  }

  // 1) ëŸ°íƒ€ì„ ì—ëŸ¬
  window.addEventListener
('error', (ev) => {
    reportError({
      type: 'error',
      message: ev?.message,
      filename: ev?.filename,
      lineno: ev?.lineno,
      colno: ev?.colno,
      stack: ev?.error?.stack?.toString()?.slice(0, 2000),
    });
  });

  // 2) Promise ë¯¸ì²˜ë¦¬ ê±°ë¶€
  window.addEventListener
('unhandledrejection', (ev) => {
    const reason = ev?.reason;
    reportError({
      type: 'unhandledrejection',
      message: (reason && (reason.message
 || reason.toString
())) || 'unhandledrejection',
      stack: reason && reason.stack ? String(reason.stack).slice(0, 2000) : undefined,
    });
  });

  // 3) fetch ë˜í¼: API ì‹¤íŒ¨ ìë™ ë¦¬í¬íŠ¸(ì„ íƒ)
  window.safeFetch = async function safeFetch(input, init) {
    const res = await fetch(input, init).catch((e) => {
      reportError({ type: 'network', message: 'fetch_failed', detail: String(e), req: String(input) });
      throw e;
    });
    if (!res.ok) {
      reportError({
        type: 'api',
        message: 'http_' + res.status,
        req: String(input),
      });
    }
    return res;
  };

  // 4) ìˆ˜ë™ ë¦¬í¬íŠ¸ API (ê°œë°œì/ë¹„ì„œê°€ í˜¸ì¶œ ê°€ëŠ¥)
  window.reportAiProblem = function (hint) {
    reportError({ type: 'ai', message: 'AI ì‘ë‹µ ì´ìƒ', detail: hint });
  };

  // 5) ì£¼ê¸°ì  í•˜íŠ¸ë¹„íŠ¸(ì„ íƒ): ì„œë¹„ìŠ¤ ì •ìƒ ë™ì‘ í™•ì¸
  (async () => {
    try { await fetch('/api/report?ping=1', { method: 'GET', keepalive: true }); } catch {}
  })();
})();
</script>
</body>
</html>
