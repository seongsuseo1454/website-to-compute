<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ì‹œì¥ë‹˜ ì§‘ë¬´ì‹¤ Â· ìŠ¤ë§ˆíŠ¸ ë¯¸ëŸ¬ PRO</title>

<!-- PWA -->
<link rel="manifest" href="/manifest.webmanifest" />
<link rel="icon" sizes="192x192" href="/icon-192.png" />
<link rel="icon" sizes="512x512" href="/icon-512.png" />
<meta name="theme-color" content="#0b0f19" />

<link rel="stylesheet" href="/style.css" />
</head>
<body>
<main class="container">
  <!-- ìƒë‹¨ ì¸ì‚¬/ì‹œê³„ -->
  <section class="hero">
    <div>
      <h1 id="greet">í™œê¸°ì°¬ í•˜ë£¨ì…ë‹ˆë‹¤, ì‹œì¥ë‹˜</h1>
      <p class="sub" id="today"></p>
    </div>
    <div class="clock" id="clock">--:--</div>
  </section>

  <!-- ë¹ ë¥¸ ì—…ë¬´ íŠ¸ë¦¬ê±° (#trstart ìœ ì§€) -->
  <section id="trstart" class="card">
    <div class="title">ì—…ë¬´ íŠ¸ë¦¬ê±° & ë¹ ë¥¸ ì „í™˜</div>
    <div class="desc">ëŒ€í‘œ/ì´ê´„ì‹¤ì¥ ë‹¨ì¶• íŒ¨ë„ì…ë‹ˆë‹¤. ìì£¼ ì“°ëŠ” ëª…ë ¹ì„ í„°ì¹˜ë¡œ ì‹¤í–‰í•˜ì„¸ìš”.</div>
    <div class="row">
      <button class="btn" onclick="
        document.getElementById('msgInput').value='ë‚´ì¼ 10ì‹œ ë³µì§€ê³¼ íšŒì˜ ì¶”ê°€';
        document.getElementById('chatForm').dispatchEvent(new Event('submit',{cancelable:true}))">
        ë‚´ì¼ 10ì‹œ íšŒì˜ ì¶”ê°€
      </button>
      <button class="btn" onclick="location.href='/admin.html'">ê´€ë¦¬ì ì…ë ¥ì°½</button>
    </div>
  </section>

  <!-- ì˜¤ëŠ˜ì˜ ë‚ ì”¨ -->
  <section class="card">
    <header class="card-title">ì˜¤ëŠ˜ì˜ ë‚ ì”¨</header>
    <div id="weatherBox" class="weather">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
  </section>

  <!-- AI ë¹„ì„œ (ì±„íŒ… + ìŒì„±) -->
  <section class="card">
    <header class="card-title">AI ë¹„ì„œ (ì±„íŒ… + ìŒì„±)</header>
    <div id="chat" class="chat">
      <div class="bot">ì•ˆë…•í•˜ì„¸ìš”, ì‹œì¥ë‹˜. ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?</div>
    </div>

    <form id="chatForm" class="chat-form">
      <button type="button" id="micBtn" title="ìŒì„±ìœ¼ë¡œ ë§í•˜ê¸°" class="ghost big-mic">ğŸ¤</button>
      <input id="msgInput" type="text" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”. (ì˜ˆ: ì˜¤ëŠ˜ ì¼ì • ìš”ì•½)" autocomplete="off" />
      <button type="submit" class="primary">ë³´ë‚´ê¸°</button>
    </form>

    <div class="tts-row">
      <label><input type="checkbox" id="ttsToggle" checked /> ì‘ë‹µì„ ìŒì„±ìœ¼ë¡œ ì½ê¸°</label>
      <div class="spacer"></div>
      <button id="ttsPause" class="ghost">â¸ï¸ ì¼ì‹œì •ì§€</button>
      <button id="ttsResume" class="ghost">â–¶ï¸ ì¬ê°œ</button>
      <button id="ttsStop" class="danger ghost">â–  ì •ì§€</button>
    </div>
    <p class="hint">â€» íŠ¹ìˆ˜ë¬¸ì/ì´ëª¨ì§€/ë§ˆí¬ë‹¤ìš´ ë“±ì€ ì½ê¸° ì „ì— ìë™ ì •ë¦¬ë©ë‹ˆë‹¤.</p>
  </section>

  <!-- ì˜¤ëŠ˜ ì¼ì • -->
  <section class="card">
    <header class="card-title">ì˜¤ëŠ˜ ì¼ì •</header>
    <ul id="schedList" class="sched"></ul>
  </section>

  <!-- ì‹œì • ë‰´ìŠ¤ / ë¶€ì„œë³„ ë³´ê³  -->
  <section class="grid">
    <div class="card">
      <header class="card-title">ì‹œì • ë‰´ìŠ¤</header>
      <ul id="newsList" class="feed"></ul>
    </div>
    <div class="card">
      <header class="card-title">ë¶€ì„œë³„ ì—…ë¬´ë³´ê³ </header>
      <ul id="deptList" class="feed"></ul>
    </div>
  </section>

  <!-- ì‹¤ì‹œê°„ í†µì—­ (14ê°œ ì–¸ì–´) -->
  <section class="card">
    <header class="card-title">ì‹¤ì‹œê°„ í†µì—­</header>

    <div class="row" style="gap:12px; align-items:center; flex-wrap:wrap">
      <label>ì…ë ¥(ë§í•˜ê¸°)
        <select id="trSrc">
          <option value="ko">í•œêµ­ì–´</option><option value="en">English</option>
          <option value="ja">æ—¥æœ¬èª</option><option value="zh">ä¸­æ–‡</option>
          <option value="fr">FranÃ§ais</option><option value="de">Deutsch</option>
          <option value="es">EspaÃ±ol</option><option value="pt">PortuguÃªs</option>
          <option value="ru">Ğ ÑƒÑÑĞºĞ¸Ğ¹</option><option value="vi">Tiáº¿ng Viá»‡t</option>
          <option value="th">à¹„à¸—à¸¢</option><option value="id">Bahasa Indonesia</option>
          <option value="ar">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option><option value="hi">à¤¹à¤¿à¤¨à¥à¤¦à¥€</option>
        </select>
      </label>

      <label>ì¶œë ¥(ì½ì–´ì£¼ê¸°)
        <select id="trDst">
          <option value="en">English</option><option value="ko">í•œêµ­ì–´</option>
          <option value="ja">æ—¥æœ¬èª</option><option value="zh">ä¸­æ–‡</option>
          <option value="fr">FranÃ§ais</option><option value="de">Deutsch</option>
          <option value="es">EspaÃ±ol</option><option value="pt">PortuguÃªs</option>
          <option value="ru">Ğ ÑƒÑÑĞºĞ¸Ğ¹</option><option value="vi">Tiáº¿ng Viá»‡t</option>
          <option value="th">à¹„à¸—à¸¢</option><option value="id">Bahasa Indonesia</option>
          <option value="ar">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option><option value="hi">à¤¹à¤¿à¤¨à¥à¤¦à¥€</option>
        </select>
      </label>

      <button id="trStart" class="btn-xl primary" title="ë§í•˜ê¸° ì‹œì‘">ğŸ¤ í¬ê²Œ ë§í•˜ê¸°</button>
      <button id="trStop"  class="ghost danger" disabled>â–  í†µì—­ ì •ì§€</button>
    </div>

    <div class="row" style="gap:12px; margin-top:12px">
      <textarea id="trIn"  class="mono" placeholder="ì…ë ¥ ì¸ì‹ í…ìŠ¤íŠ¸â€¦" rows="2" style="flex:1"></textarea>
      <textarea id="trOut" class="mono" placeholder="ë²ˆì—­ ê²°ê³¼â€¦" rows="2" style="flex:1"></textarea>
    </div>

    <div class="row" style="gap:8px; margin-top:8px">
      <button id="trTranslate" class="ghost">í…ìŠ¤íŠ¸ ë²ˆì—­</button>
      <button id="trSpeak" class="ghost">â–¶ï¸ ë²ˆì—­ ì½ì–´ì£¼ê¸°</button>
    </div>
  </section>

  <!-- ë°”ë‹¥ í‘œì‹œ -->
  <footer class="footer">Â© ë…¼ì‚°ì‹œ ìŠ¤ë§ˆíŠ¸ë¯¸ëŸ¬ Â· ë£¨ë¯¸ë‚˜ PRO</footer>
</main>

<!-- ì—ëŸ¬ ë°°ì§€ -->
<style>
.error-badge{position:fixed;right:12px;bottom:12px;background:#ff4d4f;color:#fff;padding:8px 10px;border-radius:8px;font-size:12px;display:none;z-index:9999}
</style>
<div id="errorBadge" class="error-badge">ë¬¸ì œ ê°ì§€ Â· íŒ€ì— ë³´ê³ ë¨</div>

<!-- ë¹„ì„œ ë¡œì§(ì„ í–‰ ì œê³µëœ /ai.js ì‚¬ìš©). ì—†ìœ¼ë©´ ì•ˆì „ í´ë°± -->
<script src="/ai.js"></script>

<script>
/* ===== í´ë°±: TTS ì•ˆì „ ì •ë¦¬(sanitizeForTTS) â€“ /ai.jsì— ì—†ìœ¼ë©´ ì´ ë²„ì „ ì‚¬ìš© ===== */
if (!window.sanitizeForTTS) {
  window.sanitizeForTTS = function (input) {
    let s = String(input ?? '');
    s = s.replace(/https?:\/\/\S+/g, '');                          // URL ì œê±°
    s = s.replace(/[\*\_\`\~\^\#\>\<\|\:\\\/\[\]\{\}\-]+/g, ' ');  // ë§ˆí¬ë‹¤ìš´/ê¸°í˜¸
    try { s = s.replace(/\p{Extended_Pictographic}/gu, ''); } catch (e) {}
    s = s.replace(/[\u0000-\u001F\u007F-\u009F]/g, '');            // ì œì–´ë¬¸ì
    return s.replace(/\s{2,}/g, ' ').trim();
  };
}

/* ===== ê³µí†µ ===== */
const $ = (s)=>document.querySelector(s);
const chat = $('#chat'), input=$('#msgInput'), form=$('#chatForm');
const micBtn=$('#micBtn'), ttsToggle=$('#ttsToggle');
const ttsPause=$('#ttsPause'), ttsResume=$('#ttsResume'), ttsStop=$('#ttsStop');

// ì‹œê³„/ë‚ ì§œ/ì¸ì‚¬
function tick(){
  const now=new Date();
  $('#clock').textContent = now.toLocaleTimeString('ko-KR',{hour:'2-digit',minute:'2-digit'});
  $('#today').textContent = now.toLocaleDateString('ko-KR',{year:'numeric',month:'2-digit',day:'2-digit',weekday:'long'});
  const h=now.getHours();
  $('#greet').textContent = (h<12?'ì¢‹ì€ ì•„ì¹¨ì…ë‹ˆë‹¤':'í™œê¸°ì°¬ í•˜ë£¨ì…ë‹ˆë‹¤') + ', ì‹œì¥ë‹˜';
}
setInterval(tick,1000); tick();

// ì±„íŒ… ì¶œë ¥
function pushMsg(role, text){
  const div=document.createElement('div');
  div.className = role==='user'?'user':'bot';
  div.textContent = text;
  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;
}

/* ===== TTS ===== */
function speak(text){
  if(!ttsToggle.checked) return;
  const line = window.sanitizeForTTS ? window.sanitizeForTTS(text): text;
  if(!line) return;
  window.speechSynthesis.cancel();
  const u=new SpeechSynthesisUtterance(line);
  u.lang='ko-KR'; u.rate=1.0; u.pitch=1.0;
  window.speechSynthesis.speak(u);
}
ttsPause.onclick=()=>window.speechSynthesis.pause();
ttsResume.onclick=()=>window.speechSynthesis.resume();
ttsStop.onclick=()=>window.speechSynthesis.cancel();

/* ===== STT (ì±„íŒ…ìš©) ===== */
let rec;
if('webkitSpeechRecognition' in window){
  const R=window.webkitSpeechRecognition; rec=new R();
  rec.lang='ko-KR'; rec.continuous=false; rec.interimResults=false;
  rec.onresult=(e)=>{ const txt=e.results[0][0].transcript; input.value=txt;
    form.dispatchEvent(new Event('submit',{cancelable:true})); };
  rec.onerror=()=>alert('ìŒì„± ì¸ì‹ ì˜¤ë¥˜. ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.');
}else{
  micBtn.disabled=true; micBtn.title='ì´ ë¸Œë¼ìš°ì €ëŠ” ìŒì„± ì¸ì‹ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.';
}
micBtn.onclick=()=>{ try{ rec && rec.start(); }catch(_){} };

/* ===== AI í˜¸ì¶œ ===== */
async function callAI(prompt){
  if(typeof window.askAI==='function') return await window.askAI(prompt);
  const res = await fetch('/api/ai',{ method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({prompt})});
  if(!res.ok) throw new Error('AI ì‘ë‹µ ì‹¤íŒ¨');
  const data=await res.json();
  return data.text || data.reply || JSON.stringify(data);
}

/* ===== ì „ì†¡ ì²˜ë¦¬ ===== */
form.addEventListener('submit', async (e)=>{
  e.preventDefault();
  const q=input.value.trim(); if(!q) return;
  input.value=''; pushMsg('user',q);
  try{
    const a = await callAI(q);
    pushMsg('bot', a); speak(a);
  }catch(err){
    const msg='ì—ëŸ¬ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ê³§ ì¡°ì¹˜í•˜ê² ìŠµë‹ˆë‹¤.'; pushMsg('bot', msg); speak(msg);
    fetch('/api/report',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({type:'AI_FAIL',detail:String(err)})}).catch(()=>{});
  }
});

/* ===== ë‚ ì”¨: ëª¨ë°”ì¼ ìœ„ì¹˜ â†’ KMA ê²©ì(nx,ny) ë³€í™˜ í›„ í˜¸ì¶œ ===== */
function latlonToGrid(lat, lon) {
  // KMA LCC(ê¸°ìƒì²­) ì¢Œí‘œê³„ ë³€í™˜ (nx, ny)
  const RE=6371.00877, GRID=5.0, SLAT1=30.0, SLAT2=60.0, OLON=126.0, OLAT=38.0, XO=43, YO=136;
  const DEGRAD=Math.PI/180.0;
  const re=RE/GRID;
  const slat1=SLAT1*DEGRAD, slat2=SLAT2*DEGRAD, olon=OLON*DEGRAD, olat=OLAT*DEGRAD;
  let sn=Math.tan(Math.PI*0.25+slat2*0.5)/Math.tan(Math.PI*0.25+slat1*0.5);
  sn=Math.log(Math.cos(slat1)/Math.cos(slat2))/Math.log(sn);
  let sf=Math.tan(Math.PI*0.25+slat1*0.5);
  sf=Math.pow(sf,sn)*Math.cos(slat1)/sn;
  let ro=Math.tan(Math.PI*0.25+olat*0.5);
  ro=re*sf/Math.pow(ro,sn);
  let ra=Math.tan(Math.PI*0.25+(lat)*DEGRAD*0.5);
  ra=re*sf/Math.pow(ra,sn);
  let theta=lon*DEGRAD-olon;
  if(theta>Math.PI) theta-=2.0*Math.PI;
  if(theta<-Math.PI) theta+=2.0*Math.PI;
  theta*=sn;
  const nx=Math.floor(ra*Math.sin(theta)+XO+0.5);
  const ny=Math.floor(ro-ra*Math.cos(theta)+YO+0.5);
  return {nx, ny};
}

async function loadWeather(){
  try{
    const setText = (t)=>($('#weatherBox').textContent=t);
    // ìœ„ì¹˜ ê¶Œí•œ ì‹œë„
    if (navigator.geolocation) {
      await new Promise((resolve)=> {
        navigator.geolocation.getCurrentPosition(async (pos)=>{
          const {latitude, longitude}=pos.coords;
          const {nx, ny}=latlonToGrid(latitude, longitude);
          const res = await fetch(`/api/weather?nx=${nx}&ny=${ny}`).catch(()=>null);
          if (res && res.ok) {
            const data = await res.json();
            setText(data?.summary || 'í˜„ì¬ ìœ„ì¹˜ ê¸°ì¤€ ë‚ ì”¨ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
          } else setText('ë‚ ì”¨ API ì‘ë‹µì´ ì—†ìŠµë‹ˆë‹¤.');
          resolve();
        }, async ()=>{
          // ê±°ë¶€/ì‹¤íŒ¨ ì‹œ ì„œìš¸ ê¸°ë³¸ ì¢Œí‘œ
          const res = await fetch(`/api/weather?nx=60&ny=127`).catch(()=>null);
          if (res && res.ok) {
            const data = await res.json();
            setText(data?.summary || 'ë‚ ì”¨ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
          } else setText('ë‚ ì”¨ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
          resolve();
        }, {enableHighAccuracy:false, timeout:4000});
      });
    } else {
      const res = await fetch(`/api/weather?nx=60&ny=127`);
      const data = await res.json();
      $('#weatherBox').textContent = data?.summary || 'ë‚ ì”¨ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
    }
  }catch{ $('#weatherBox').textContent='ë‚ ì”¨ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'; }
}
loadWeather();

/* ===== ì¼ì •/ë‰´ìŠ¤/ë³´ê³  ===== */
async function loadKV(listId, key){
  try{
    const res = await fetch(`/api/admin?list=${encodeURIComponent(key)}`);
    if(!res.ok) throw 0;
    const items = await res.json(); renderList(listId, items);
  }catch{ renderList(listId, []); }
}
function renderList(id, items){
  const el=$(id); el.innerHTML='';
  if(!items || !items.length){
    const li=document.createElement('li'); li.className='empty';
    li.textContent='ë“±ë¡ëœ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.'; el.appendChild(li); return;
  }
  for(const it of items){
    const li=document.createElement('li');
    li.innerHTML=`<div class="feed-title">${it.title||it.text}</div>
                  <div class="feed-sub">${it.time||it.source||''} ${it.location||''}</div>`;
    el.appendChild(li);
  }
}
loadKV('#schedList','SCHEDULE:TODAY');
loadKV('#newsList','NEWS');
loadKV('#deptList','DEPT');

/* ===== ì—ëŸ¬ë°°ì§€ & ìµœì†Œ ë¦¬í¬íŠ¸ ===== */
window.addEventListener('error',()=>{$('#errorBadge').style.display='block';});
window.addEventListener('unhandledrejection',()=>{$('#errorBadge').style.display='block';});

/* ===== ì‹¤ì‹œê°„ í†µì—­(14ê°œ) â€“ STTâ†’ë²ˆì—­â†’TTS ===== */
const trMap = {
  ko:'ko-KR', en:'en-US', ja:'ja-JP', zh:'zh-CN',
  fr:'fr-FR', de:'de-DE', es:'es-ES', pt:'pt-PT',
  ru:'ru-RU', vi:'vi-VN', th:'th-TH', id:'id-ID',
  ar:'ar-SA', hi:'hi-IN'
};
const trNames = {
  ko:'Korean', en:'English', ja:'Japanese', zh:'Chinese',
  fr:'French', de:'German', es:'Spanish', pt:'Portuguese',
  ru:'Russian', vi:'Vietnamese', th:'Thai', id:'Indonesian',
  ar:'Arabic', hi:'Hindi'
};

const trSrc = $('#trSrc'), trDst = $('#trDst');
const trStart = $('#trStart'), trStop = $('#trStop');
const trIn = $('#trIn'), trOut = $('#trOut');
const trTranslate = $('#trTranslate'), trSpeak = $('#trSpeak');

let trRec;
if ('webkitSpeechRecognition' in window) {
  const R = window.webkitSpeechRecognition;
  trRec = new R();
  trRec.continuous = true;
  trRec.interimResults = true;
  trRec.onresult = (e)=>{
    let final=''; let interim='';
    for (let i = e.resultIndex; i < e.results.length; i++) {
      const t = e.results[i][0].transcript;
      if (e.results[i].isFinal) final += t + ' ';
      else interim += t;
    }
    trIn.value = (final + interim).trim();
  };
  trRec.onerror = ()=> alert('í†µì—­ ìŒì„± ì¸ì‹ ì˜¤ë¥˜. ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.');
}

trStart.onclick = ()=>{
  if (!trRec) { alert('ì´ ë¸Œë¼ìš°ì €ëŠ” ìŒì„± ì¸ì‹ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.'); return; }
  try {
    const lang = trMap[trSrc.value] || 'ko-KR';
    trRec.lang = lang;
    trRec.start();
    trStart.disabled = true; trStop.disabled = false;
  } catch {}
};
trStop.onclick = ()=>{
  try { trRec && trRec.stop(); } catch {}
  trStart.disabled = false; trStop.disabled = true;
};

async function translateText(text, src, dst) {
  if (!text?.trim()) return '';
  // 1) ì „ìš© ë²ˆì—­ APIê°€ ìˆìœ¼ë©´ ì‚¬ìš© (/api/translate)
  try {
    const r = await fetch('/api/translate', {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ text, src, dst })
    });
    if (r.ok) return (await r.json())?.text || '';
  } catch {}
  // 2) í´ë°±: /api/ai ë¡œ ë²ˆì—­ í”„ë¡¬í”„íŠ¸
  const prompt = `Translate the following text from ${trNames[src]||src} to ${trNames[dst]||dst}. Only the translation.\n\n"${text}"`;
  try {
    const ans = await callAI(prompt);
    return (ans||'').trim();
  } catch {
    return '';
  }
}

trTranslate.onclick = async ()=>{
  const src = trSrc.value, dst = trDst.value;
  trOut.value = 'ë²ˆì—­ ì¤‘â€¦';
  const out = await translateText(trIn.value, src, dst);
  trOut.value = out || 'ë²ˆì—­ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.';
};

trSpeak.onclick = ()=>{
  const line = window.sanitizeForTTS(trOut.value);
  if (!line) return;
  window.speechSynthesis.cancel();
  const u = new SpeechSynthesisUtterance(line);
  // ëŒ€ìƒ ì–¸ì–´ ë³´ì´ìŠ¤ ì„ íƒ(ê°€ëŠ¥í•œ ê²½ìš°)
  u.lang = trMap[trDst.value] || 'en-US';
  window.speechSynthesis.speak(u);
};
</script>
</body>
</html>
