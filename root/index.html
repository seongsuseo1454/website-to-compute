<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>시장님 집무실 · 스마트 미러 PRO</title>

  <!-- PWA -->
  <link rel="manifest" href="/manifest.webmanifest" />
  <link rel="icon" sizes="192x192" href="/icon-192.png" />
  <link rel="icon" sizes="512x512" href="/icon-512.png" />
  <meta name="theme-color" content="#0b0f19" />

  <link rel="stylesheet" href="/style.css" />
  <style>
    /* 최소 보완 (기존 style.css 유지 가정) */
    .container { max-width: 980px; margin: 24px auto; padding: 16px; }
    .hero { display:flex; justify-content:space-between; align-items:flex-end; margin-bottom: 16px; }
    .hero .sub { opacity:.8 }
    .clock { font-size: 40px; font-weight: 800; opacity:.8 }
    .card { background: rgba(255,255,255,.03); border:1px solid rgba(255,255,255,.08); border-radius:14px; padding:16px; margin-bottom:16px }
    .card-title { font-weight: 800; margin-bottom: 10px; opacity:.9 }
    .row { display:flex; gap:12px; align-items:center; flex-wrap:wrap }
    .grid2 { display:grid; grid-template-columns: 1fr 1fr; gap:16px }
    @media (max-width: 820px){ .grid2 { grid-template-columns: 1fr } }
    .chat{display:flex;flex-direction:column;gap:8px;height:260px;overflow:auto;padding:8px;background:rgba(0,0,0,.15);border-radius:12px}
    .chat .user{align-self:flex-end;background:#3451ff1a;border:1px solid #3451ff44;padding:10px 12px;border-radius:12px 12px 2px 12px;max-width:85%}
    .chat .bot{align-self:flex-start;background:#ffffff0f;border:1px solid #ffffff22;padding:10px 12px;border-radius:12px 12px 12px 2px;max-width:85%}
    .chat-form{display:flex;gap:8px;margin-top:10px}
    .chat-form input{flex:1;padding:10px 12px;border-radius:10px;border:1px solid #ffffff25;background:rgba(255,255,255,.03);color:inherit}
    .primary{background:#3b82f6;border:0;color:#fff;border-radius:10px;padding:10px 16px}
    .ghost{background:transparent;border:1px solid #ffffff33;color:inherit;border-radius:10px;padding:10px 12px}
    .danger{border-color:#ff6868;color:#ff9b9b}
    .label{opacity:.7}
    .value{font-weight:800}
    .big-mic{font-size:22px;padding:12px 14px}
    .foot{opacity:.6;text-align:center;margin-top:10px}
    .hint{opacity:.6;margin-top:8px}
    .tts-row{display:flex;gap:8px;align-items:center;margin-top:8px}
    .spacer{flex:1}
    .error-badge{position:fixed;right:12px;bottom:12px;background:#ff4d4f;color:#fff;padding:8px 10px;border-radius:8px;font-size:12px;display:none;z-index:9999}
  </style>
</head>
<body>
  <main class="container">
    <!-- 상단 인사/시계 -->
    <section class="hero">
      <div>
        <h1 id="greet">시장님 안녕하세요</h1>
        <p class="sub" id="today">YYYY.MM.DD (요일)</p>
      </div>
      <div class="clock" id="clock">--:--</div>
    </section>

    <!-- 날씨 -->
    <section class="card">
      <header class="card-title">현재 날씨</header>
      <div class="row" style="justify-content:space-between">
        <div class="row" style="gap:32px">
          <div><span class="label">온도</span>: <span id="temp" class="value">-℃</span></div>
          <div><span class="label">습도</span>: <span id="reh" class="value">-%</span></div>
          <div><span class="label">강수(1h)</span>: <span id="rn1" class="value">- mm</span></div>
          <div><span class="label">풍속</span>: <span id="wsd" class="value">- m/s</span></div>
        </div>
        <button id="btnWx" class="ghost">날씨 업데이트</button>
      </div>
    </section>

    <div class="grid2">
      <!-- AI 비서 -->
      <section class="card">
        <header class="card-title">AI 비서 채팅</header>
        <div id="chat" class="chat">
          <div class="bot">안녕하세요, 시장님. 무엇을 도와드릴까요?</div>
        </div>

        <form id="chatForm" class="chat-form">
          <button type="button" id="micBtn" title="음성으로 말하기" class="ghost big-mic">🎤</button>
          <input id="msgInput" type="text" placeholder="메시지를 입력하세요. (예: 오늘 일정 요약)" autocomplete="off" />
          <button type="submit" class="primary">보내기</button>
        </form>

        <div class="tts-row">
          <label><input type="checkbox" id="ttsToggle" checked /> 응답을 음성으로 읽기</label>
          <div class="spacer"></div>
          <button id="ttsPause" class="ghost">⏸︎ 일시정지</button>
          <button id="ttsResume" class="ghost">▶︎ 재개</button>
          <button id="ttsStop" class="danger ghost">■ 정지</button>
        </div>
        <p class="hint">※ 특수문자/이모지/마크다운 등은 읽기 전에 자동 정리됩니다.</p>
      </section>

      <!-- 실시간 통역 -->
      <section class="card">
        <header class="card-title">실시간 통역</header>
        <div class="row">
          <span class="label">입력(말하기) 언어</span>
          <select id="langIn"></select>
          <span class="label">출력(읽어주기) 언어</span>
          <select id="langOut"></select>
          <div class="spacer"></div>
          <button id="btnTrStart" class="primary">통역 시작</button>
          <button id="btnTrStop" class="ghost danger">통역 정지</button>
        </div>
        <div id="trArea" class="chat" style="height:180px;margin-top:10px">
          <div class="bot">[tip] 마이크 권한 허용 후 “통역 시작”을 누르고 말씀해 주세요.</div>
        </div>
        <div class="row" style="margin-top:8px">
          <button id="btnSpeakLast" class="ghost">🔊 마지막 번역 읽기</button>
          <span id="trStatus" class="hint">(대기 중)</span>
        </div>
      </section>
    </div>

    <footer class="foot">© 논산시 스마트미러 · 루미나 PRO</footer>
  </main>

  <!-- 에러 배지 -->
  <div id="errorBadge" class="error-badge">문제 감지 · 팀에 보고됨</div>

  <!-- AI/통역 유틸 (export 없이 전역 attach → 브라우저 SyntaxError 방지) -->
  <script src="/ai.js"></script>

  <script>
    const $ = (s) => document.querySelector(s);

    // ---------------- 시간/날짜 ----------------
    function tick(){
      const now = new Date();
      $('#clock').textContent = now.toLocaleTimeString
('ko-KR',{hour:'2-digit',minute:'2-digit'});
      $('#today').textContent = now.toLocaleDateString
('ko-KR',{year:'numeric',month:'2-digit',day:'2-digit',weekday:'long'});
    }
    setInterval(tick,1000); tick();

    // ---------------- 날씨 ----------------
    async function loadWeather() {
      try{
        const r = await fetch('/api/weather');
        const d = await r.json();
        if (d && d.ok){
          $('#temp').textContent = (d.tempC ?? '-') + '℃';
          $('#reh').textContent  = (d.reh ?? '-') + '%';
          $('#rn1').textContent  = (d.rn1 ?? '-') + ' mm';
          $('#wsd').textContent  = (d.wsd ?? '-') + ' m/s';
        } else {
          throw new Error('no ok');
        }
      }catch(e){
        $('#temp').textContent='-℃'; $('#reh').textContent='-%'; $('#rn1').textContent='- mm'; $('#wsd').textContent='- m/s';
      }
    }
    $('#btnWx').onclick = loadWeather;
    loadWeather();

    // ---------------- 채팅 ----------------
    const chat = $('#chat'); const input = $('#msgInput'); const form = $('#chatForm');
    function pushMsg(role, text){
      const div = document.createElement('div');
      div.className = role === 'user' ? 'user' : 'bot';
      div.textContent = text;
      chat.appendChild
(div);
      chat.scrollTop = chat.scrollHeight;
    }

    async function callAI(prompt){
      if (typeof window.askAI === 'function') return await window.askAI(prompt);
      // 폴백(서버 없으면 에코)
      return '네, "'+prompt+'"에 대해 확인했습니다.';
    }

    form.addEventListener
('submit', async (e)=>{
      e.preventDefault();
      const q = input.value.trim(); if(!q) return;
      input.value=''; pushMsg('user', q);
      try{
        const a = await callAI(q);
        pushMsg('bot', a); speak(a);
      }catch{
        const msg='에러가 발생했습니다. 잠시 후 다시 시도해 주세요.'; pushMsg('bot', msg); speak(msg);
      }
    });

    // ---------------- 음성 합성 TTS ----------------
    const ttsToggle=$('#ttsToggle'), ttsPause=$('#ttsPause'), ttsResume=$('#ttsResume'), ttsStop=$('#ttsStop');
    function speak(text){
      if(!ttsToggle.checked) return;
      const line = (window.sanitizeForTTS||((s)=>s))(text);
      if(!line) return;
      speechSynthesis.cancel
();
      const u = new SpeechSynthesisUtterance(line);
      u.lang = 'ko-KR'; u.rate=1.0; u.pitch=1.0;
      speechSynthesis.speak(u);
    }
    ttsPause.onclick=()=>speechSynthesis.pause();
    ttsResume.onclick=()=>speechSynthesis.resume();
    ttsStop.onclick=()=>speechSynthesis.cancel
();

    // ---------------- 음성 인식 STT ----------------
    let rec=null;
    if('webkitSpeechRecognition' in window){
      const R = window.webkitSpeechRecognition;
      rec = new R(); rec.lang='ko-KR'; rec.continuous
=false; rec.interimResults
=false;
      rec.onresult=(e)=>{ input.value=e.results[0][0].transcript; form.dispatchEvent(new Event('submit',{cancelable:true})); };
      rec.onerror=()=>alert('음성 인식 오류가 발생했습니다.');
      $('#micBtn').onclick=()=>{ try{ rec.start(); }catch(_){} };
    }else{
      $('#micBtn').disabled = true; $('#micBtn').title='이 브라우저는 음성 인식을 지원하지 않습니다.';
    }

    // ---------------- 실시간 통역 ----------------
    const LANGS = window.TR_LANGS;      // ai.js에서 제공
    const tr = $('#trArea'), st = $('#trStatus'), selIn=$('#langIn'), selOut=$('#langOut');
    for (const [code, name] of LANGS) {
      const o1=document.createElement('option'); o1.value=code; o1.textContent=name; selIn.appendChild
(o1);
      const o2=document.createElement('option'); o2.value=code; o2.textContent=name; selOut.appendChild
(o2);
    }
    selIn.value='ko'; selOut.value='en';

    let recTr=null, lastTranslated='';
    function pushTr(role, text){
      const div=document.createElement('div'); div.className=role==='me'?'user':'bot'; div.textContent=text; tr.appendChild(div); tr.scrollTop=tr.scrollHeight;
    }
    async function translateAndSpeak(text, from, to){
      const out = await (window.translateText ? window.translateText(text, from, to) : Promise.resolve(text));
      lastTranslated = out; pushTr('bot', `[${to}] ${out}`);
      const u = new SpeechSynthesisUtterance(out); u.lang = window.langToVoice[to] || 'en-US'; speechSynthesis.speak(u);
    }
    $('#btnSpeakLast').onclick=()=>{ if(!lastTranslated) return; const u=new SpeechSynthesisUtterance(lastTranslated); u.lang=window.langToVoice[selOut.value]||'en-US'; speechSynthesis.speak(u); };

    $('#btnTrStart').onclick=()=>{
      if(!('webkitSpeechRecognition' in window)){ alert('브라우저가 실시간 통역을 지원하지 않습니다.'); return; }
      if(recTr) return;
      const R = window.webkitSpeechRecognition;
      recTr = new R(); recTr.lang = window.langToVoice[selIn.value] || 'ko-KR'; recTr.continuous
=true; recTr.interimResults
=false;
      recTr.onresult = async (e)=>{ const txt=e.results[e.results.length-1][0].transcript; pushTr('me', `[${selIn.value}] ${txt}`); try{ await translateAndSpeak(txt, selIn.value, selOut.value);}catch{ pushTr('bot','(통역 오류)'); } };
      recTr.onstart=()=>{ st.textContent='(통역 중)'; pushTr('bot','🎤 통역 시작'); };
      recTr.onend=()=>{ st.textContent='(대기 중)'; pushTr('bot','⏹ 통역 종료'); recTr=null; };
      try{ recTr.start(); }catch{}
    };
    $('#btnTrStop').onclick=()=>{ try{ recTr && recTr.stop(); }catch{} };

    // ---------------- 에러 자동 뱃지 ----------------
    function showErr(){ document.getElementById('errorBadge').style.display='block'; }
    window.addEventListener
('error', showErr);
    window.addEventListener
('unhandledrejection', showErr);
  </script>
</body>
</html>
