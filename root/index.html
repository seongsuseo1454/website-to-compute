<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ì‹œì¥ë‹˜ ì§‘ë¬´ì‹¤ Â· ìŠ¤ë§ˆíŠ¸ ë¯¸ëŸ¬ PRO</title>

  <!-- PWA -->
  <link rel="manifest" href="/manifest.webmanifest" />
  <link rel="icon" sizes="192x192" href="/icon-192.png" />
  <link rel="icon" sizes="512x512" href="/icon-512.png" />
  <meta name="theme-color" content="#0b0f19" />

  <!-- ì„ íƒ: ê¸°ì¡´ style.css ìœ ì§€ -->
  <link rel="stylesheet" href="/style.css" />
  <style>
    /* ìµœì†Œí•œì˜ ê¸°ë³¸ ìŠ¤íƒ€ì¼ (style.css ì—†ì„ ê²½ìš° ëŒ€ë¹„) */
    body{margin:0;background:#0b0f19;color:#fff;font-family:system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,sans-serif}
    .container{max-width:1100px;margin:0 auto;padding:24px}
    .hero{display:flex;align-items:end;justify-content:space-between;margin:8px 0 20px}
    .hero h1{margin:.2rem 0;font-size:28px}
    .sub{opacity:.8;margin:0}
    .clock{font-size:40px;font-weight:700}
    .card{background:rgba(255,255,255,.08);backdrop-filter:blur(6px);border:1px solid rgba(255,255,255,.15);
          border-radius:16px;padding:16px}
    .card-title{font-weight:700;margin-bottom:10px}
    .chat{display:flex;flex-direction:column;gap:8px;max-height:42vh;overflow:auto;padding:8px;background:rgba(0,0,0,.2);
          border-radius:12px}
    .chat .user{align-self:flex-end;background:#2d6cdf;color:#fff;padding:10px 12px;border-radius:14px 14px 2px 14px;max-width:80%}
    .chat .bot{align-self:flex-start;background:#1c2333;color:#e9ecf4;padding:10px 12px;border-radius:14px 14px 14px 2px;max-width:80%}
    .chat-form{display:flex;gap:8px;margin-top:10px}
    .chat-form input{flex:1;padding:12px;border-radius:10px;border:1px solid #3a4361;background:#0f1525;color:#e9ecf4}
    .primary{background:#2d6cdf;color:#fff;border:0;padding:12px 16px;border-radius:10px;cursor:pointer}
    .ghost{background:transparent;color:#cdd5ff;border:1px solid #3a4361;padding:10px 12px;border-radius:10px;cursor:pointer}
    .danger{color:#ff9ea0;border-color:#6b1e25}
    .tts-row{display:flex;align-items:center;gap:10px;margin-top:8px}
    .spacer{flex:1}
    .footer{opacity:.6;margin-top:20px;text-align:center}
    .error-badge{position:fixed;right:12px;bottom:12px;background:#ff4d4f;color:#fff;padding:8px 10px;border-radius:8px;
                 font-size:12px;display:none;z-index:9999}
  </style>
</head>
<body>
<main class="container">
  <!-- ìƒë‹¨ ì¸ì‚¬/ì‹œê³„ -->
  <section class="hero">
    <div>
      <h1 id="greet">í™œê¸°ì°¬ í•˜ë£¨ì…ë‹ˆë‹¤, ì‹œì¥ë‹˜</h1>
      <p class="sub" id="today"></p>
    </div>
    <div class="clock" id="clock">--:--</div>
  </section>

  <!-- AI ë¹„ì„œ (ì±„íŒ… + ìŒì„±) -->
  <section class="card">
    <header class="card-title">AI ë¹„ì„œ (ì±„íŒ… + ìŒì„±)</header>

    <div id="chat" class="chat">
      <div class="bot">ì•ˆë…•í•˜ì„¸ìš”, ì‹œì¥ë‹˜. ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?</div>
    </div>

    <form id="chatForm" class="chat-form" autocomplete="off">
      <button type="button" id="micBtn" title="ìŒì„±ìœ¼ë¡œ ë§í•˜ê¸°" class="ghost">ğŸ¤</button>
      <input id="msgInput" type="text" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”. (ì˜ˆ: ì˜¤ëŠ˜ ì¼ì • ìš”ì•½)" />
      <button type="submit" class="primary">ë³´ë‚´ê¸°</button>
    </form>

    <div class="tts-row">
      <label><input type="checkbox" id="ttsToggle" checked /> ì‘ë‹µì„ ìŒì„±ìœ¼ë¡œ ì½ê¸°</label>
      <div class="spacer"></div>
      <button id="ttsPause" class="ghost">â¸ï¸ ì¼ì‹œì •ì§€</button>
      <button id="ttsResume" class="ghost">â–¶ï¸ ì¬ê°œ</button>
      <button id="ttsStop" class="danger ghost">â–  ì •ì§€</button>
    </div>

    <p class="sub" style="margin-top:6px;opacity:.75">
      â€» íŠ¹ìˆ˜ë¬¸ì/ì´ëª¨ì§€/ë§ˆí¬ë‹¤ìš´ì€ ìë™ ì •ë¦¬ í›„ ì½ìŠµë‹ˆë‹¤.
    </p>
  </section>

  <footer class="footer">Â© ë…¼ì‚°ì‹œ ìŠ¤ë§ˆíŠ¸ë¯¸ëŸ¬ Â· ë£¨ë¯¸ë‚˜ PRO</footer>
</main>

<!-- ì—ëŸ¬ ë°°ì§€ -->
<div id="errorBadge" class="error-badge">ë¬¸ì œ ê°ì§€ Â· íŒ€ì— ë³´ê³ ë¨</div>

<!-- ì•± ìŠ¤í¬ë¦½íŠ¸ (ëª¨ë“ˆ) -->
<script type="module">
  import { sanitizeForTTS, askAI, reportClientError } from './ai.js';

  // ===== DOM ì°¸ì¡° =====
  const $      = (s) => document.querySelector(s);
  const chat   = $('#chat');
  const form   = $('#chatForm');
  const input  = $('#msgInput');
  const micBtn = $('#micBtn');
  const ttsOn  = $('#ttsToggle');
  const ttsPause  = $('#ttsPause');
  const ttsResume = $('#ttsResume');
  const ttsStop   = $('#ttsStop');

  // ===== ì‹œê³„/ë‚ ì§œ =====
  function tick() {
    const now = new Date();
    $('#clock').textContent = now.toLocaleTimeString
('ko-KR',{hour:'2-digit',minute:'2-digit'});
    $('#today').textContent = now.toLocaleDateString
('ko-KR',{year:'numeric',month:'2-digit',day:'2-digit',weekday:'long'});
  }
  setInterval(tick,1000); tick();

  // ===== ì±„íŒ… UI =====
  function pushMsg(role, text) {
    const div = document.createElement('div');
    div.className = role === 'user' ? 'user' : 'bot';
    div.textContent = text;
    chat.appendChild
(div);
    chat.scrollTop = chat.scrollHeight;
  }

  // ===== TTS ì œì–´ =====
  function speak(text) {
    if (!ttsOn.checked) return;
    const clean = sanitizeForTTS(text);
    if (!clean) return;
    window.speechSynthesis.cancel
();
    const u = new SpeechSynthesisUtterance(clean);
    u.lang = 'ko-KR';
    u.rate = 1.0;
    u.pitch = 1.0;
    window.speechSynthesis.speak(u);
  }
  ttsPause.onclick  = () => window.speechSynthesis.pause();
  ttsResume.onclick = () => window.speechSynthesis.resume();
  ttsStop.onclick   = () => window.speechSynthesis.cancel
();

  // ===== STT(ìŒì„± ì¸ì‹) =====
  let rec;
  if ('webkitSpeechRecognition' in window) {
    rec = new webkitSpeechRecognition();
    rec.lang = 'ko-KR';
    rec.continuous
 = false;
    rec.interimResults
 = false;
    rec.onresult = (e) => {
      input.value = e.results[0][0].transcript;
      form.dispatchEvent(new Event('submit', { cancelable: true }));
    };
    rec.onerror = () => alert('ìŒì„± ì¸ì‹ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.');
  } else {
    micBtn.disabled = true;
    micBtn.title = 'ì´ ë¸Œë¼ìš°ì €ëŠ” ìŒì„± ì¸ì‹ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.';
  }
  micBtn.onclick = () => { try { rec && rec.start(); } catch(_) {} };

  // ===== ì „ì†¡ ì²˜ë¦¬ =====
  form.addEventListener
('submit', async (e) => {
    e.preventDefault();
    const q = input.value.trim();
    if (!q) return;
    input.value = '';
    pushMsg('user', q);

    try {
      const a = await askAI(q);   // <-- ai.js í˜¸ì¶œ
      pushMsg('bot', a);
      speak(a);
    } catch (err) {
      const msg = 'ì—ëŸ¬ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ê³§ ì¡°ì¹˜í•˜ê² ìŠµë‹ˆë‹¤.';
      pushMsg('bot', msg);
      speak(msg);
      reportClientError({ type:'ai', message:String(err) }).catch(()=>{});
      // í•„ìš”í•˜ë©´: await fetch('/api/alert', {method:'POST',body:JSON.stringify({...})})
    }
  });

  // ===== ì „ì—­ ì—ëŸ¬ ë±ƒì§€ =====
  const badge = document.getElementById('errorBadge');
  function showBadge(){ badge.style.display='block'; }
  window.addEventListener
('error', () => { showBadge(); reportClientError({type:'error'}); });
  window.addEventListener
('unhandledrejection', () => { showBadge(); reportClientError({type:'unhandledrejection'}); });
</script>
</body>
</html>
